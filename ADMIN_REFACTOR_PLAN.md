# 后台管理系统重构实施方案

## 📋 总体目标

重构后台管理系统,区分普通用户和管理员权限,实现:
- 普通用户管理自己的内容(卡片式)
- 管理员管理所有内容(列表式)
- 统一的审核发布流程

---

## 🎯 实施阶段

### ✅ 阶段1: 基础架构搭建 (1-2小时)

**目标**: 建立新的路由和菜单结构,不影响现有功能

**任务列表**:
1. ✅ 更新侧边栏菜单 (`NewAdminLayout.tsx`)
   - 普通用户菜单: 仪表盘、文章管理、视频管理、图片管理、个人中心
   - 管理员额外菜单: 行程管理、标签管理、文章列表、视频列表、图片列表

2. ⏳ 更新路由配置 (`App.tsx`)
   ```
   /admin/my-articles      → MyArticleList (卡片式)
   /admin/my-videos        → MyVideoList (卡片式)
   /admin/my-gallery       → MyGalleryList (卡片式)
   /admin/articles/all     → AllArticleList (列表式,仅管理员)
   /admin/videos/all       → AllVideoList (列表式,仅管理员)
   /admin/gallery/all      → AllGalleryList (列表式,仅管理员)
   ```

3. ⏳ 添加数据库字段
   - `articles.rejection_reason` - 驳回理由 (TEXT)
   - `videos.rejection_reason` - 驳回理由 (TEXT)
   - `photo_groups.rejection_reason` - 驳回理由 (TEXT)

4. ⏳ 创建占位页面
   - 创建简单的占位组件,确保路由可访问
   - 显示"功能开发中"提示

**验收标准**:
- ✅ 侧边栏菜单根据角色正确显示
- ⏳ 所有新路由可访问(显示占位页面)
- ⏳ 数据库迁移成功
- ⏳ 现有功能不受影响

---

### 阶段2: 共享组件开发 (2-3小时)

**目标**: 创建可复用的UI组件

**任务列表**:
1. 状态徽章组件 (`StatusBadge.tsx`)
   - 已发布: 绿色 CheckCircle
   - 待审核: 黄色 Clock
   - 驳回: 红色 XCircle (hover显示驳回理由tooltip)

2. 内容卡片组件 (`ContentCard.tsx`)
   - 封面图片
   - 标题、分类、标签
   - 状态徽章(右上角)
   - 操作按钮(编辑、查看)
   - 支持文章/视频/图片三种类型

3. 筛选栏组件 (`FilterBar.tsx`)
   - 搜索框
   - 分类下拉
   - 状态下拉
   - 统一样式

**验收标准**:
- 组件可独立使用
- 样式符合设计规范
- Tooltip正常显示

---

### 阶段3: "我的内容"页面 (4-6小时)

**目标**: 实现普通用户的内容管理页面(卡片式)

**任务列表**:

#### 3.1 MyArticleList (我的文章)
- 布局: 卡片网格
- 显示: 封面、标题、分类、标签、摘要、日期、浏览量、状态
- 筛选: 搜索、分类、状态
- 操作: 编辑、查看
- API: 添加 `author_id` 参数过滤

#### 3.2 MyVideoList (我的视频)
- 布局: 卡片网格
- 显示: 封面、标题、分类、标签、作者、日期、状态
- 筛选: 搜索、分类、状态
- 操作: 编辑、查看

#### 3.3 MyGalleryList (我的图片)
- 布局: 卡片网格
- 显示: 封面、标题、分类、标签、描述、日期、状态
- 筛选: 搜索、分类、状态
- 操作: 编辑、查看

**验收标准**:
- 只显示当前用户创建的内容
- 卡片样式统一美观
- 筛选功能正常
- 状态徽章显示正确

---

### 阶段4: 管理员"全部内容"页面 (4-6小时)

**目标**: 实现管理员的内容审核页面(列表式)

**任务列表**:

#### 4.1 AllArticleList (所有文章)
- 布局: 表格列表
- 显示: 标题、作者、分类、状态、发布日期、浏览量
- 筛选: 搜索、分类、状态、作者
- 操作:
  - 已发布 → 编辑按钮
  - 待审核 → 审核按钮
- API: 返回所有用户的文章

#### 4.2 AllVideoList (所有视频)
- 布局: 表格列表
- 显示: 标题、BVID、作者、分类、状态、发布日期
- 操作同上

#### 4.3 AllGalleryList (所有图片)
- 布局: 表格列表
- 显示: 标题、作者、分类、状态、日期、图片数量
- 操作同上

**验收标准**:
- 显示所有用户的内容
- 列表样式统一
- 根据状态显示不同操作按钮
- 仅管理员可访问

---

### 阶段5: 编辑器多模式支持 (6-8小时)

**目标**: 修改现有编辑器,支持不同的使用场景

**任务列表**:

#### 5.1 ArticleEditor 模式支持
```typescript
interface ArticleEditorProps {
  mode: 'create' | 'edit-own' | 'edit-admin' | 'review';
  initialData?: Article;
}
```

**模式行为**:
- `create`: 创建文章 → 按钮"发布"(实际提交审核)
- `edit-own`: 编辑自己的文章 → 按钮"更新"+"删除"(重新提交审核)
- `edit-admin`: 管理员编辑已发布文章 → 按钮"更新"+"删除"(直接更新)
- `review`: 管理员审核待审核文章 → 按钮"审核通过"+"驳回"

#### 5.2 VideoEditor 模式支持
同上逻辑

#### 5.3 GalleryUpload 模式支持
同上逻辑

**验收标准**:
- 按钮文字和行为符合模式
- 从不同入口进入显示正确模式
- 审核和编辑流程正确

---

### 阶段6: API和数据库适配 (2-3小时)

**目标**: 调整后端API支持新功能

**任务列表**:

1. 文章API (`backend/app/routers/articles.py`)
   - GET `/api/articles/my` - 获取当前用户的文章
   - GET `/api/articles/all` - 获取所有文章(仅管理员)
   - PUT `/api/articles/{id}/reject` - 驳回文章(带理由)

2. 视频API (`backend/app/routers/videos.py`)
   - 同上

3. 图片API (`backend/app/routers/gallery.py`)
   - 同上

4. 数据库迁移
   - 执行SQL添加 `rejection_reason` 字段

**验收标准**:
- API返回正确的数据
- 权限验证正确
- 驳回理由可保存和查询

---

### 阶段7: 集成测试和优化 (2-3小时)

**目标**: 确保整体流程顺畅

**测试场景**:

1. **普通用户流程**
   - 创建文章 → 提交审核 → 查看"待审核"状态
   - 编辑待审核文章 → 重新提交 → 状态保持"待审核"
   - 文章被驳回 → 查看驳回理由 → 重新编辑 → 再次提交

2. **管理员流程**
   - 查看所有待审核内容
   - 审核通过 → 前台显示
   - 驳回并填写理由 → 用户可见
   - 编辑已发布内容 → 直接更新,不重新审核

3. **权限测试**
   - 普通用户无法访问"全部XXX"页面
   - 普通用户只能看到自己的内容
   - 管理员可以看到所有内容

**验收标准**:
- 所有测试场景通过
- 无权限漏洞
- 用户体验流畅

---

## 📊 工作量估算

| 阶段 | 预计时间 | 复杂度 |
|------|---------|--------|
| 阶段1 | 1-2h | 低 |
| 阶段2 | 2-3h | 中 |
| 阶段3 | 4-6h | 中 |
| 阶段4 | 4-6h | 中 |
| 阶段5 | 6-8h | 高 |
| 阶段6 | 2-3h | 中 |
| 阶段7 | 2-3h | 中 |
| **总计** | **21-31h** | - |

---

## 🎨 设计规范

### 卡片样式
```
┌─────────────────────────┐
│ [状态徽章]      [封面图] │
│ 标题                    │
│ 分类 | 标签1 标签2      │
│ 摘要/描述...            │
│ 📅 日期  👁️ 浏览量      │
│ [编辑] [查看]           │
└─────────────────────────┘
```

### 列表样式
```
| 标题 | 作者 | 分类 | 状态 | 日期 | 操作 |
|------|------|------|------|------|------|
| ...  | ...  | ...  | ...  | ...  | ...  |
```

### 颜色规范
- 已发布: `text-green-500` + `CheckCircle`
- 待审核: `text-yellow-500` + `Clock`
- 驳回: `text-red-500` + `XCircle`
- 主题色: `wangfeng-purple` (#8B5CF6)

---

## 📝 注意事项

1. **兼容性**: 确保新功能不影响现有前台展示
2. **性能**: 卡片加载使用分页或虚拟滚动
3. **安全**: 严格验证用户权限
4. **用户体验**: 操作要有明确的反馈提示
5. **数据完整性**: 迁移时保留现有数据

---

## 🚀 部署计划

1. **开发环境测试** → 功能验证
2. **预发布环境** → 性能测试
3. **灰度发布** → 部分用户试用
4. **全量发布** → 所有用户

---

**文档版本**: v1.0
**创建日期**: 2025-01-14
**最后更新**: 2025-01-14
