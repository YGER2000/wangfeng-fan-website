# æ±ªå³°ç²‰ä¸ç½‘ç«™ - ç”¨æˆ·ç™»å½•ç³»ç»Ÿå®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æ•°æ®å­˜å‚¨](#æ•°æ®å­˜å‚¨)
4. [è®¤è¯æµç¨‹](#è®¤è¯æµç¨‹)
5. [ç”¨æˆ·è§’è‰²ä¸æƒé™](#ç”¨æˆ·è§’è‰²ä¸æƒé™)
6. [API æ¥å£](#api-æ¥å£)
7. [å‰ç«¯å®ç°](#å‰ç«¯å®ç°)
8. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
9. [éƒ¨ç½²ä¸åˆå§‹åŒ–](#éƒ¨ç½²ä¸åˆå§‹åŒ–)
10. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿé‡‡ç”¨ **JWT (JSON Web Token)** è®¤è¯æœºåˆ¶ï¼Œå®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰ã€‚æ‰€æœ‰ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨ **MySQL æ•°æ®åº“**ä¸­ï¼Œä¸ä½¿ç”¨ä»»ä½•æœ¬åœ°æ–‡ä»¶å­˜å‚¨æˆ–æ¨¡æ‹Ÿæ•°æ®ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… çº¯ MySQL æ•°æ®åº“å­˜å‚¨
- âœ… JWT Token è®¤è¯
- âœ… BCrypt å¯†ç åŠ å¯†
- âœ… åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- âœ… Token è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- âœ… å®‰å…¨çš„å¯†ç é‡ç½®
- âœ… é‚®ç®±éªŒè¯æ”¯æŒ

---

## æŠ€æœ¯æ¶æ„

### åç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | FastAPI | ç°ä»£ã€é«˜æ€§èƒ½çš„ Python Web æ¡†æ¶ |
| æ•°æ®åº“ | MySQL 8.0+ | å…³ç³»å‹æ•°æ®åº“ |
| ORM | SQLAlchemy | Python SQL å·¥å…·åŒ…å’Œ ORM |
| è®¤è¯ | JWT | JSON Web Token è®¤è¯ |
| å¯†ç åŠ å¯† | BCrypt | è¡Œä¸šæ ‡å‡†å¯†ç å“ˆå¸Œç®—æ³• |
| æ•°æ®åº“è¿æ¥æ±  | PyMySQL | Python MySQL å®¢æˆ·ç«¯ |

### å‰ç«¯æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | React 18 | ç”¨æˆ·ç•Œé¢åº“ |
| è·¯ç”± | React Router | å®¢æˆ·ç«¯è·¯ç”± |
| çŠ¶æ€ç®¡ç† | Context API | å…¨å±€è®¤è¯çŠ¶æ€ç®¡ç† |
| HTTP å®¢æˆ·ç«¯ | Fetch API | åŸç”Ÿ HTTP è¯·æ±‚ |
| æœ¬åœ°å­˜å‚¨ | localStorage | Token å’Œç”¨æˆ·ä¿¡æ¯ç¼“å­˜ |

---

## æ•°æ®å­˜å‚¨

### MySQL æ•°æ®åº“é…ç½®

**æ•°æ®åº“è¿æ¥ä¿¡æ¯**ï¼ˆ`backend/app/database.py`ï¼‰ï¼š

```python
DATABASE_USER = "root"
DATABASE_PASSWORD = "123456"
DATABASE_HOST = "localhost"
DATABASE_PORT = "3306"
DATABASE_NAME = "wangfeng_fan_website"
```

å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼š

```bash
export DATABASE_USER=your_user
export DATABASE_PASSWORD=your_password
export DATABASE_HOST=localhost
export DATABASE_PORT=3306
export DATABASE_NAME=wangfeng_fan_website
```

### ç”¨æˆ·è¡¨ç»“æ„

**è¡¨å**: `users`

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| id | INTEGER | PRIMARY KEY, AUTO_INCREMENT | ç”¨æˆ·å”¯ä¸€æ ‡è¯† |
| username | VARCHAR(50) | UNIQUE, NOT NULL, INDEX | ç”¨æˆ·åï¼ˆæ”¯æŒä¸­æ–‡ï¼‰ |
| email | VARCHAR(100) | UNIQUE, NOT NULL, INDEX | é‚®ç®±åœ°å€ |
| hashed_password | VARCHAR(255) | NOT NULL | BCrypt åŠ å¯†åçš„å¯†ç  |
| avatar | VARCHAR(500) | NULLABLE | å¤´åƒè·¯å¾„ |
| role | VARCHAR(20) | NOT NULL, DEFAULT='user', INDEX | ç”¨æˆ·è§’è‰² |
| is_active | BOOLEAN | NOT NULL, DEFAULT=TRUE | è´¦æˆ·æ˜¯å¦æ¿€æ´» |
| status | VARCHAR(20) | NOT NULL, DEFAULT='active', INDEX | ç”¨æˆ·çŠ¶æ€ |
| created_at | DATETIME | NOT NULL, DEFAULT=CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | NOT NULL, ON UPDATE | æ›´æ–°æ—¶é—´ |
| last_login | DATETIME | NULLABLE | æœ€åç™»å½•æ—¶é—´ |

**SQLAlchemy æ¨¡å‹**ï¼ˆ`backend/app/models/user_db.py`ï¼‰ï¼š

```python
class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, autoincrement=True, index=True)
    username = Column(String(50), unique=True, nullable=False, index=True)
    email = Column(String(100), unique=True, nullable=False, index=True)
    hashed_password = Column(String(255), nullable=False)
    avatar = Column(String(500), nullable=True)
    role = Column(String(20), default="user", nullable=False, index=True)
    is_active = Column(Boolean, default=True, nullable=False)
    status = Column(String(20), default="active", nullable=False, index=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    last_login = Column(DateTime, nullable=True)
```

---

## è®¤è¯æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    participant ç”¨æˆ·
    participant å‰ç«¯
    participant åç«¯API
    participant MySQL

    ç”¨æˆ·->>å‰ç«¯: è¾“å…¥ç”¨æˆ·å/å¯†ç 
    å‰ç«¯->>åç«¯API: POST /api/auth/login
    åç«¯API->>MySQL: æŸ¥è¯¢ç”¨æˆ·
    MySQL-->>åç«¯API: è¿”å›ç”¨æˆ·æ•°æ®
    åç«¯API->>åç«¯API: éªŒè¯å¯†ç (BCrypt)
    åç«¯API->>åç«¯API: ç”Ÿæˆ JWT Token
    åç«¯API->>MySQL: æ›´æ–° last_login
    åç«¯API-->>å‰ç«¯: è¿”å› Token
    å‰ç«¯->>å‰ç«¯: å­˜å‚¨ Token åˆ° localStorage
    å‰ç«¯->>åç«¯API: GET /api/auth/me (å¸¦ Token)
    åç«¯API->>MySQL: æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    åç«¯API-->>å‰ç«¯: è¿”å›ç”¨æˆ·è¯¦æƒ…
    å‰ç«¯->>å‰ç«¯: æ›´æ–°å…¨å±€çŠ¶æ€
    å‰ç«¯-->>ç”¨æˆ·: è·³è½¬åˆ°ç®¡ç†åå°
```

### 2. Token éªŒè¯æµç¨‹

```mermaid
sequenceDiagram
    participant å‰ç«¯
    participant åç«¯API
    participant MySQL

    å‰ç«¯->>åç«¯API: è¯·æ±‚å—ä¿æŠ¤èµ„æº (å¸¦ Bearer Token)
    åç«¯API->>åç«¯API: è§£æ JWT Token
    alt Token æœ‰æ•ˆ
        åç«¯API->>MySQL: æ ¹æ® username æŸ¥è¯¢ç”¨æˆ·
        MySQL-->>åç«¯API: è¿”å›ç”¨æˆ·ä¿¡æ¯
        åç«¯API->>åç«¯API: æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        åç«¯API-->>å‰ç«¯: è¿”å›è¯·æ±‚æ•°æ®
    else Token æ— æ•ˆ/è¿‡æœŸ
        åç«¯API-->>å‰ç«¯: 401 Unauthorized
        å‰ç«¯->>å‰ç«¯: æ¸…é™¤ localStorage
        å‰ç«¯->>å‰ç«¯: è·³è½¬åˆ°ç™»å½•é¡µ
    end
```

### 3. å¯†ç åŠ å¯†æœºåˆ¶

ä½¿ç”¨ **BCrypt** ç®—æ³•è¿›è¡Œå¯†ç åŠ å¯†ï¼ˆ`backend/app/core/security.py`ï¼‰ï¼š

```python
import bcrypt

def get_password_hash(password: str) -> str:
    """ç”Ÿæˆå¯†ç å“ˆå¸Œ"""
    password_bytes = password.encode('utf-8')
    if len(password_bytes) > 72:
        password_bytes = password_bytes[:72]  # BCrypt é™åˆ¶

    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password_bytes, salt)
    return hashed.decode('utf-8')

def verify_password(plain_password: str, hashed_password: str) -> bool:
    """éªŒè¯å¯†ç """
    return bcrypt.checkpw(
        plain_password.encode('utf-8'),
        hashed_password.encode('utf-8')
    )
```

### 4. JWT Token ç”Ÿæˆ

**Token é…ç½®**ï¼ˆ`backend/app/core/config.py`ï¼‰ï¼š

```python
SECRET_KEY = "your-secret-key-here"  # ç”Ÿäº§ç¯å¢ƒå¿…é¡»æ›´æ¢
ALGORITHM = "HS256"
ACCESS_TOKEN_EXPIRE_MINUTES = 10080  # 7 å¤©
```

**Token ç”Ÿæˆå‡½æ•°**ï¼ˆ`backend/app/core/security.py`ï¼‰ï¼š

```python
import jwt
from datetime import datetime, timedelta

def create_access_token(data: dict, expires_delta: timedelta = None):
    """åˆ›å»ºè®¿é—®ä»¤ç‰Œ"""
    to_encode = data.copy()
    if expires_delta:
        expire = datetime.utcnow() + expires_delta
    else:
        expire = datetime.utcnow() + timedelta(minutes=15)

    to_encode.update({"exp": expire})
    encoded_jwt = jwt.encode(to_encode, SECRET_KEY, algorithm=ALGORITHM)
    return encoded_jwt
```

---

## ç”¨æˆ·è§’è‰²ä¸æƒé™

### è§’è‰²å®šä¹‰

ç³»ç»Ÿæ”¯æŒå››ç§ç”¨æˆ·è§’è‰²ï¼ˆ`backend/app/models/roles.py`ï¼‰ï¼š

| è§’è‰² | å€¼ | æƒé™ç­‰çº§ | è¯´æ˜ |
|------|-----|----------|------|
| æ¸¸å®¢ | guest | 0 | æœªç™»å½•ç”¨æˆ·ï¼Œåªè¯»æƒé™ |
| æ™®é€šç”¨æˆ· | user | 1 | å·²æ³¨å†Œç”¨æˆ·ï¼Œå¯è¯„è®ºã€ç‚¹èµ |
| ç®¡ç†å‘˜ | admin | 2 | å†…å®¹ç®¡ç†æƒé™ |
| è¶…çº§ç®¡ç†å‘˜ | super_admin | 3 | å®Œå…¨æ§åˆ¶æƒé™ |

### æƒé™ç­‰çº§

```python
class UserRole(str, enum.Enum):
    GUEST = "guest"
    USER = "user"
    ADMIN = "admin"
    SUPER_ADMIN = "super_admin"

def get_hierarchy(role: UserRole) -> int:
    hierarchy = {
        UserRole.GUEST: 0,
        UserRole.USER: 1,
        UserRole.ADMIN: 2,
        UserRole.SUPER_ADMIN: 3
    }
    return hierarchy.get(role, 0)
```

### æƒé™æ£€æŸ¥

**åç«¯æƒé™ä¾èµ–**ï¼ˆ`backend/app/core/dependencies.py`ï¼‰ï¼š

```python
def get_current_active_user(current_user: User = Depends(get_current_user)) -> User:
    """è·å–å½“å‰æ´»è·ƒç”¨æˆ·"""
    if not current_user.is_active:
        raise HTTPException(status_code=400, detail="ç”¨æˆ·å·²è¢«ç¦ç”¨")
    return current_user
```

**å‰ç«¯æƒé™æ£€æŸ¥**ï¼ˆ`frontend/src/contexts/AuthContext.tsx`ï¼‰ï¼š

```typescript
export const hasPermission = (userRole: UserRole, requiredRole: UserRole): boolean => {
  return getRoleHierarchy(userRole) >= getRoleHierarchy(requiredRole);
};

// ä½¿ç”¨ç¤ºä¾‹
const { hasPermission } = useAuth();

if (hasPermission('admin')) {
  // æ˜¾ç¤ºç®¡ç†åŠŸèƒ½
}
```

---

## API æ¥å£

### è®¤è¯ç›¸å…³æ¥å£

#### 1. ç”¨æˆ·ç™»å½•

**ç«¯ç‚¹**: `POST /api/auth/login`

**è¯·æ±‚ä½“**:
```json
{
  "username": "å¿§éƒçš„çœ¼ç›o",
  "password": "123456"
}
```

**å“åº”**:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**å®ç°ä»£ç **ï¼ˆ`backend/app/routers/auth.py`ï¼‰:

```python
@router.post("/login", response_model=Token)
def login(
    user_data: UserLogin,
    user_service: UserServiceMySQL = Depends(get_user_service)
):
    """ç”¨æˆ·ç™»å½•"""
    user = user_service.authenticate_user(user_data.username, user_data.password)

    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
            headers={"WWW-Authenticate": "Bearer"},
        )

    if not user.is_active:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="ç”¨æˆ·å·²è¢«ç¦ç”¨"
        )

    # æ›´æ–°æœ€åç™»å½•æ—¶é—´
    user_service.update_user_last_login(user.id)

    # åˆ›å»ºè®¿é—®ä»¤ç‰Œ
    access_token_expires = timedelta(minutes=settings.access_token_expire_minutes)
    access_token = create_access_token(
        data={"sub": user.username}, expires_delta=access_token_expires
    )

    return {
        "access_token": access_token,
        "token_type": "bearer"
    }
```

#### 2. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**ç«¯ç‚¹**: `GET /api/auth/me`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <access_token>
```

**å“åº”**:
```json
{
  "id": 1,
  "username": "å¿§éƒçš„çœ¼ç›o",
  "email": "511186155@qq.com",
  "role": "super_admin",
  "role_name": "è¶…çº§ç®¡ç†å‘˜",
  "is_active": true
}
```

#### 3. ç”¨æˆ·æ³¨å†Œ

**ç«¯ç‚¹**: `POST /api/auth/register`

**è¯·æ±‚ä½“**:
```json
{
  "username": "æ–°ç”¨æˆ·",
  "email": "user@example.com",
  "password": "password123",
  "full_name": "å…¨åï¼ˆå¯é€‰ï¼‰"
}
```

**å“åº”**:
```json
{
  "id": 2,
  "username": "æ–°ç”¨æˆ·",
  "email": "user@example.com",
  "role": "user",
  "role_name": "æ™®é€šç”¨æˆ·",
  "is_active": true
}
```

#### 4. åˆå§‹åŒ–è¶…çº§ç®¡ç†å‘˜

**ç«¯ç‚¹**: `POST /api/auth/init-super-admin`

**è¯·æ±‚ä½“**: æ— 

**å“åº”**:
```json
{
  "id": 1,
  "username": "root",
  "email": "root@wangfeng.fan",
  "role": "super_admin",
  "role_name": "è¶…çº§ç®¡ç†å‘˜",
  "is_active": true
}
```

**è¯´æ˜**: æ­¤æ¥å£ä»…åœ¨ç³»ç»Ÿä¸­ä¸å­˜åœ¨è¶…çº§ç®¡ç†å‘˜æ—¶å¯ç”¨ï¼Œåˆ›å»ºç”¨æˆ·åä¸º `root`ï¼Œå¯†ç ä¸º `123456` çš„è¶…çº§ç®¡ç†å‘˜ã€‚

---

## å‰ç«¯å®ç°

### AuthContext å…¨å±€çŠ¶æ€

**æ–‡ä»¶**: `frontend/src/contexts/AuthContext.tsx`

```typescript
export interface User {
  id: number;
  username: string;
  email: string;
  role: UserRole;
  role_name: string;
  is_active: boolean;
}

export interface AuthContextType {
  user: User | null;
  token: string | null;
  currentRole: UserRole;
  login: (username: string, password: string) => Promise<void>;
  logout: () => void;
  isLoading: boolean;
  hasPermission: (requiredRole: UserRole) => boolean;
}
```

### ç™»å½•æµç¨‹å®ç°

```typescript
const login = async (username: string, password: string) => {
  try {
    // 1. è°ƒç”¨ç™»å½•æ¥å£
    const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'ç™»å½•å¤±è´¥');
    }

    const data = await response.json();
    const authToken = data.access_token;

    // 2. è·å–ç”¨æˆ·ä¿¡æ¯
    const userResponse = await fetch(`${API_BASE_URL}/api/auth/me`, {
      headers: { 'Authorization': `Bearer ${authToken}` },
    });

    if (!userResponse.ok) {
      throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
    }

    const userData = await userResponse.json();

    // 3. ä¿å­˜åˆ°çŠ¶æ€å’Œ localStorage
    setToken(authToken);
    setUser(userData);
    localStorage.setItem('access_token', authToken);
    localStorage.setItem('token', authToken); // å…¼å®¹æ—§ä»£ç 
    localStorage.setItem('user', JSON.stringify(userData));
  } catch (error) {
    console.error('ç™»å½•å¤±è´¥:', error);
    throw error;
  }
};
```

### ç™»å½•é¡µé¢ç»„ä»¶

**æ–‡ä»¶**: `frontend/src/components/admin/AdminLogin.tsx`

æ ¸å¿ƒåŠŸèƒ½ï¼š
- ç”¨æˆ·å/å¯†ç è¾“å…¥
- å¯†ç æ˜¾ç¤º/éšè—åˆ‡æ¢
- é”™è¯¯æç¤º
- åŠ è½½çŠ¶æ€
- ç™»å½•æˆåŠŸåè·³è½¬åˆ° `/admin/dashboard`

```typescript
const handleSubmit = async (e: React.FormEvent) => {
  e.preventDefault();
  setError('');
  setLoading(true);

  try {
    await login(username, password);
    navigate('/admin/dashboard');
  } catch (err) {
    setError(err instanceof Error ? err.message : 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ');
  } finally {
    setLoading(false);
  }
};
```

### å—ä¿æŠ¤è·¯ç”±

ä½¿ç”¨ `ProtectedRoute` ç»„ä»¶åŒ…è£¹éœ€è¦è®¤è¯çš„é¡µé¢ï¼š

```typescript
function ProtectedRoute({ children, requiredRole = 'user' }: ProtectedRouteProps) {
  const { user, isLoading, hasPermission } = useAuth();

  if (isLoading) {
    return <div>åŠ è½½ä¸­...</div>;
  }

  if (!user || !hasPermission(requiredRole)) {
    return <Navigate to="/admin/login" replace />;
  }

  return <>{children}</>;
}
```

---

## å®‰å…¨æœºåˆ¶

### 1. å¯†ç å®‰å…¨

- âœ… ä½¿ç”¨ BCrypt åŠ å¯†ï¼ˆcost factor = 12ï¼‰
- âœ… å¯†ç é•¿åº¦é™åˆ¶ï¼ˆæœ€å¤§ 72 å­—èŠ‚ï¼‰
- âœ… ä¸åœ¨æ—¥å¿—æˆ–é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²å¯†ç 
- âœ… å¯†ç å“ˆå¸Œä¸å¯é€†

### 2. Token å®‰å…¨

- âœ… JWT ç­¾åéªŒè¯
- âœ… Token è¿‡æœŸæ—¶é—´ï¼š7 å¤©
- âœ… Token å­˜å‚¨åœ¨ localStorageï¼ˆä»…å®¢æˆ·ç«¯è®¿é—®ï¼‰
- âœ… æ¯æ¬¡è¯·æ±‚é€šè¿‡ `Authorization: Bearer` å¤´ä¼ é€’
- âœ… æœåŠ¡ç«¯éªŒè¯ Token æœ‰æ•ˆæ€§

### 3. API å®‰å…¨

- âœ… CORS é…ç½®é™åˆ¶å…è®¸çš„æ¥æº
- âœ… è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆ50MBï¼‰
- âœ… åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- âœ… æ•°æ®åº“è¿æ¥æ± ç®¡ç†
- âœ… SQL æ³¨å…¥é˜²æŠ¤ï¼ˆSQLAlchemy ORMï¼‰

### 4. æ•°æ®åº“å®‰å…¨

- âœ… å¯†ç åŠ å¯†å­˜å‚¨
- âœ… ä½¿ç”¨ ORM é˜²æ­¢ SQL æ³¨å…¥
- âœ… æ•°æ®åº“è¿æ¥æ± é…ç½®
- âœ… è‡ªåŠ¨è¿æ¥å¥åº·æ£€æŸ¥
- âœ… äº‹åŠ¡ç®¡ç†å’Œå›æ»š

---

## éƒ¨ç½²ä¸åˆå§‹åŒ–

### å‰ç½®æ¡ä»¶

1. **MySQL æ•°æ®åº“**
   ```bash
   # åˆ›å»ºæ•°æ®åº“
   mysql -u root -p
   CREATE DATABASE wangfeng_fan_website CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

2. **Python ç¯å¢ƒ**
   ```bash
   cd backend
   python3 -m venv .venv
   source .venv/bin/activate  # macOS/Linux
   # .venv\Scripts\activate  # Windows
   pip install -r requirements.txt
   ```

### åˆå§‹åŒ–æ­¥éª¤

#### 1. åˆ›å»ºæ•°æ®åº“è¡¨

åç«¯å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨ï¼ˆ`backend/app/main.py`ï¼‰ï¼š

```python
from .models.user_db import Base as UserBase
from .database import engine

# åˆ›å»ºæ‰€æœ‰æ•°æ®åº“è¡¨
UserBase.metadata.create_all(bind=engine)
```

æˆ–æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
cd backend
python3 -c "from app.database import engine; from app.models.user_db import Base; Base.metadata.create_all(bind=engine)"
```

#### 2. åˆå§‹åŒ–è¶…çº§ç®¡ç†å‘˜

**æ–¹æ³•ä¸€ï¼šä½¿ç”¨åˆå§‹åŒ–è„šæœ¬ï¼ˆæ¨èï¼‰**

```bash
cd backend
python3 init_super_admin.py
```

è¾“å‡ºï¼š
```
åˆå§‹åŒ–è¶…çº§ç®¡ç†å‘˜è´¦æˆ·...
âœ… è¶…çº§ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸï¼
============================================================
ç”¨æˆ·å: å¿§éƒçš„çœ¼ç›o
é‚®ç®±: 511186155@qq.com
å¯†ç : 123456
è§’è‰²: super_admin
============================================================
```

**æ–¹æ³•äºŒï¼šä½¿ç”¨ API æ¥å£**

```bash
curl -X POST http://localhost:1994/api/auth/init-super-admin
```

**å½“å‰è¶…çº§ç®¡ç†å‘˜è´¦æˆ·**ï¼š
- **ç”¨æˆ·å**: `å¿§éƒçš„çœ¼ç›o`
- **é‚®ç®±**: `511186155@qq.com`
- **å¯†ç **: `123456`
- **è§’è‰²**: `super_admin`

#### 3. å¯åŠ¨æœåŠ¡

**åç«¯**:
```bash
cd backend
python3 start.py
# æˆ–
uvicorn app.main:app --host 0.0.0.0 --port 1994 --reload
```

**å‰ç«¯**:
```bash
cd frontend
pnpm dev
```

#### 4. è®¿é—®ç™»å½•é¡µé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
```
http://localhost:1997/#/admin/login
```

ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜è´¦æˆ·ç™»å½•ã€‚

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: ç™»å½•å¤±è´¥ - "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

**å¯èƒ½åŸå› **:
1. âŒ å¯†ç é”™è¯¯
2. âŒ MySQL ä¸­æ²¡æœ‰è¯¥ç”¨æˆ·
3. âŒ å¯†ç å“ˆå¸Œä¸åŒ¹é…

**è§£å†³æ–¹æ³•**:

```bash
# 1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„ç”¨æˆ·
mysql -u root -p
USE wangfeng_fan_website;
SELECT id, username, email, role, is_active FROM users;

# 2. é‡ç½®è¶…çº§ç®¡ç†å‘˜å¯†ç 
cd backend
python3 init_super_admin.py
```

### é—®é¢˜ 2: 401 Unauthorized

**å¯èƒ½åŸå› **:
1. âŒ Token å·²è¿‡æœŸ
2. âŒ Token æ ¼å¼é”™è¯¯
3. âŒ ç”¨æˆ·å·²è¢«ç¦ç”¨

**è§£å†³æ–¹æ³•**:

```typescript
// å‰ç«¯ï¼šæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶é‡æ–°ç™»å½•
localStorage.removeItem('access_token');
localStorage.removeItem('token');
localStorage.removeItem('user');
window.location.href = '/#/admin/login';
```

### é—®é¢˜ 3: æ•°æ®åº“è¿æ¥å¤±è´¥

**å¯èƒ½åŸå› **:
1. âŒ MySQL æœåŠ¡æœªå¯åŠ¨
2. âŒ æ•°æ®åº“é…ç½®é”™è¯¯
3. âŒ æ•°æ®åº“ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•**:

```bash
# 1. æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
mysql --version
mysql -u root -p -e "SHOW DATABASES;"

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥é…ç½®
cat backend/app/database.py

# 3. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mysql -u root -p -e "CREATE DATABASE wangfeng_fan_website CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
```

### é—®é¢˜ 4: CORS é”™è¯¯

**å¯èƒ½åŸå› **:
å‰ç«¯åœ°å€ä¸åœ¨åç«¯ CORS å…è®¸åˆ—è¡¨ä¸­

**è§£å†³æ–¹æ³•**:

ç¼–è¾‘ `backend/app/main.py`:

```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:1997",  # æ·»åŠ ä½ çš„å‰ç«¯åœ°å€
        "http://127.0.0.1:1997",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### é—®é¢˜ 5: Token å­˜å‚¨ä¸¢å¤±

**å¯èƒ½åŸå› **:
æµè§ˆå™¨éšç§æ¨¡å¼æˆ–æ¸…é™¤äº† localStorage

**è§£å†³æ–¹æ³•**:

å‰ç«¯å¢åŠ  Token æŒä¹…åŒ–æ£€æŸ¥ï¼š

```typescript
useEffect(() => {
  const savedToken = localStorage.getItem('access_token');
  const savedUser = localStorage.getItem('user');

  if (savedToken && savedUser) {
    setToken(savedToken);
    setUser(JSON.parse(savedUser));
  }
}, []);
```

---

## é™„å½•

### A. æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ config.py          # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ security.py        # å®‰å…¨ç›¸å…³ï¼ˆå¯†ç åŠ å¯†ã€JWTï¼‰
â”‚   â”‚   â””â”€â”€ dependencies.py    # ä¾èµ–æ³¨å…¥
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ user_db.py         # ç”¨æˆ· SQLAlchemy æ¨¡å‹
â”‚   â”‚   â””â”€â”€ roles.py           # è§’è‰²å®šä¹‰
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ auth.py            # è®¤è¯è·¯ç”±
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â””â”€â”€ user.py            # Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â””â”€â”€ user_service_mysql.py  # ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ database.py            # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ main.py                # FastAPI åº”ç”¨
â”œâ”€â”€ init_super_admin.py        # åˆå§‹åŒ–è„šæœ¬
â””â”€â”€ requirements.txt           # Python ä¾èµ–

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ admin/
â”‚   â”‚       â””â”€â”€ AdminLogin.tsx # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AuthContext.tsx    # è®¤è¯ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ api.ts             # API å·¥å…·å‡½æ•°
```

### B. ä¾èµ–æ¸…å•

**åç«¯**:
```txt
fastapi
uvicorn
sqlalchemy
pymysql
bcrypt
pyjwt
python-multipart
```

**å‰ç«¯**:
```json
{
  "react": "^18.0.0",
  "react-router-dom": "^6.0.0",
  "framer-motion": "^10.0.0"
}
```

### C. ç¯å¢ƒå˜é‡

åˆ›å»º `backend/.env` æ–‡ä»¶ï¼š

```env
DATABASE_USER=root
DATABASE_PASSWORD=123456
DATABASE_HOST=localhost
DATABASE_PORT=3306
DATABASE_NAME=wangfeng_fan_website
SECRET_KEY=your-secret-key-change-in-production
ACCESS_TOKEN_EXPIRE_MINUTES=10080
```

---

## æ€»ç»“

æœ¬ç”¨æˆ·ç™»å½•ç³»ç»Ÿå®Œå…¨åŸºäº **MySQL æ•°æ®åº“**ï¼Œä¸ä½¿ç”¨ä»»ä½•æœ¬åœ°æ–‡ä»¶æˆ–æ¨¡æ‹Ÿæ•°æ®ã€‚é‡‡ç”¨ä¸šç•Œæ ‡å‡†çš„ **JWT + BCrypt** è®¤è¯æ–¹æ¡ˆï¼Œæ”¯æŒå®Œæ•´çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½å’ŒåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… çº¯æ•°æ®åº“å­˜å‚¨ï¼Œæ•°æ®å®‰å…¨å¯é 
- âœ… JWT æ— çŠ¶æ€è®¤è¯ï¼Œæ˜“äºæ‰©å±•
- âœ… BCrypt åŠ å¯†ï¼Œå¯†ç å®‰å…¨
- âœ… å®Œæ•´çš„æƒé™ä½“ç³»
- âœ… æ˜“äºéƒ¨ç½²å’Œç»´æŠ¤

**å½“å‰ç™»å½•å‡­æ®**ï¼š
- ç”¨æˆ·åï¼š`å¿§éƒçš„çœ¼ç›o`
- å¯†ç ï¼š`123456`

å¦‚éœ€é‡ç½®å¯†ç ï¼Œè¿è¡Œï¼š
```bash
cd backend
python3 init_super_admin.py
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-15
**ç»´æŠ¤è€…**: Claude Code
