# æ±ªå³°ç²‰ä¸ç½‘ - è®¤è¯ä¸æƒé™ç³»ç»Ÿåˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æ±ªå³°ç²‰ä¸ç½‘ç›®å‰é‡‡ç”¨**æ··åˆå‹è®¤è¯å’Œæƒé™ç³»ç»Ÿ**ï¼Œéƒ¨åˆ†åŠŸèƒ½å·²å®ç°ã€‚ç³»ç»Ÿæ”¯æŒJWTä»¤ç‰Œè®¤è¯ã€åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)å’ŒåŸºç¡€çš„å†…å®¹å®¡æ ¸/æ‰¹å‡†å·¥ä½œæµç¨‹ã€‚ä½†å½“å‰å®ç°ä¸BACKEND_V3_PLANæè®®çš„è¦æ±‚å­˜åœ¨é‡å¤§å·®å¼‚ã€‚

---

## 1. å½“å‰è®¤è¯ç³»ç»Ÿ

### 1.1 å®ç°ç»†èŠ‚

**æ¡†æ¶**: FastAPI + SQLAlchemy ORM + JWTä»¤ç‰Œ

**æ ¸å¿ƒç»„ä»¶**:
- **å¯†ç å“ˆå¸Œ**: BCryptï¼ˆå®‰å…¨å¼ºåº¦é«˜ï¼‰
- **ä»¤ç‰Œç±»å‹**: JWT Bearer Token
- **ä»¤ç‰Œè¿‡æœŸ**: 15åˆ†é’Ÿï¼ˆå¯é…ç½®ï¼‰
- **å­˜å‚¨ä½ç½®**: æµè§ˆå™¨localStorage
- **éªŒè¯æ–¹å¼**: JWTç­¾åéªŒè¯

**æ–‡ä»¶ä½ç½®**:
- åç«¯: `/backend/app/core/security.py`
- å‰ç«¯: `/frontend/src/contexts/AuthContext.tsx`
- ä¾èµ–: `/backend/app/core/dependencies.py`

### 1.2 ç™»å½•æµç¨‹

```
1. ç”¨æˆ·æäº¤ç”¨æˆ·å/å¯†ç åˆ° POST /api/auth/login
2. åç«¯é€šè¿‡bcryptéªŒè¯å‡­è¯
3. åç«¯ç”ŸæˆJWTä»¤ç‰Œï¼ˆsubjectä¸ºusernameï¼‰
4. åç«¯è¿”å›access_tokenï¼ˆæ— refresh tokenæœºåˆ¶ï¼‰
5. å‰ç«¯å­˜å‚¨ä»¤ç‰Œåˆ°localStorage
6. å‰ç«¯å­˜å‚¨ç”¨æˆ·å¯¹è±¡åˆ°localStorage
7. åç»­è¯·æ±‚åœ¨å¤´éƒ¨æ·»åŠ  Authorization: Bearer <token>
```

### 1.3 å½“å‰å­˜åœ¨çš„é—®é¢˜

- âŒ **æ— åˆ·æ–°ä»¤ç‰Œ**: ä»¤ç‰Œè¿‡æœŸåæ— æ³•ä¼˜é›…ç»­æœŸ
- âŒ **æ— ä»¤ç‰Œè½®æ¢**: é•¿æœŸæœ‰æ•ˆçš„ä»¤ç‰Œå­˜åœ¨å®‰å…¨é£é™©
- âŒ **localStorageè„†å¼±**: å®¹æ˜“é­å—XSSæ”»å‡»
- âŒ **æ— ä¼šè¯ç®¡ç†**: åç«¯æœªè·Ÿè¸ªä¼šè¯çŠ¶æ€
- âŒ **æ— å¯†ç é‡ç½®**: ç”¨æˆ·æ— æ³•æ¢å¤è´¦æˆ·
- âš ï¸ **é»˜è®¤å‡­è¯ç¡¬ç¼–ç **: root/123456

---

## 2. å½“å‰åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)

### 2.1 è§’è‰²å±‚çº§ç»“æ„

**4çº§å±‚çº§**ï¼ˆæƒé™ä»ä½åˆ°é«˜ï¼‰ï¼š

```
GUEST       = 0   // æœªç™»å½•ç”¨æˆ·
USER        = 1   // æ™®é€šæ³¨å†Œç”¨æˆ·
ADMIN       = 2   // ç®¡ç†å‘˜
SUPER_ADMIN = 3   // è¶…çº§ç®¡ç†å‘˜ï¼ˆç³»ç»Ÿå®Œå…¨æƒé™ï¼‰
```

**æ–‡ä»¶ä½ç½®**: `/backend/app/models/roles.py`

### 2.2 æƒé™æ£€æŸ¥å‡½æ•°

**æ–‡ä»¶**: `/backend/app/core/permissions.py`

ä¸»è¦å‡½æ•°ï¼š
- `require_role()` - é€šç”¨è§’è‰²æ£€æŸ¥
- `require_user()` - è¦æ±‚USERæˆ–æ›´é«˜æƒé™
- `require_admin()` - è¦æ±‚ADMINæˆ–æ›´é«˜æƒé™
- `require_super_admin()` - åªå…è®¸SUPER_ADMIN
- `can_publish_category()` - åˆ†ç±»ç‰¹å®šçš„å‘å¸ƒæƒé™
- `can_edit_article()` - æ–‡ç« ç¼–è¾‘æƒé™æ£€æŸ¥
- `can_delete_article()` - æ–‡ç« åˆ é™¤æƒé™æ£€æŸ¥

### 2.3 å½“å‰æƒé™è§„åˆ™

#### æŒ‰è§’è‰²çš„å‘å¸ƒæƒé™

| è§’è‰² | å³°è¨€å³°è¯­ | å³°è¿·èŸèƒ | èµ„æ–™ç§‘æ™® |
|------|---------|---------|---------|
| USER | âŒ | âœ… | âŒ |
| ADMIN | âœ… | âŒ | âœ… |
| SUPER_ADMIN | âœ… | âœ… | âœ… |

#### å†…å®¹æ“ä½œæƒé™

| æ“ä½œ | USER | ADMIN | SUPER_ADMIN |
|------|------|-------|------------|
| åˆ›å»ºå†…å®¹ | âœ… | âœ… | âœ… |
| ç¼–è¾‘è‡ªå·±çš„ | âœ… | âœ… | âœ… |
| ç¼–è¾‘ä»–äººçš„ | âŒ | âœ…(éœ€å®¡æ ¸) | âœ… |
| åˆ é™¤è‡ªå·±çš„ | âœ… | âœ… | âœ… |
| åˆ é™¤ä»–äººçš„ | âŒ | âŒ | âœ… |

### 2.4 æƒé™æ£€æŸ¥å®ç°

```python
# åç«¯ï¼šåœ¨è·¯ç”±ä¾èµ–ä¸­ä½¿ç”¨
@router.get("/admin/articles")
def get_articles_for_admin(
    current_user: User = Depends(require_admin)
):
    # ä»…ADMINåŠä»¥ä¸Šæƒé™å¯è®¿é—®
```

```typescript
// å‰ç«¯ï¼šåœ¨å—ä¿æŠ¤è·¯ç”±ä¸­ä½¿ç”¨
<ProtectedRoute allowedRoles={['admin', 'super_admin']}>
  <AdminDashboard />
</ProtectedRoute>
```

---

## 3. å†…å®¹å®¡æ ¸ä¸æ‰¹å‡†å·¥ä½œæµç¨‹

### 3.1 å®¡æ ¸çŠ¶æ€

**3ç§çŠ¶æ€**ï¼ˆå®šä¹‰åœ¨æ¨¡å‹ä¸­ï¼‰ï¼š

```python
PENDING = "pending"      # ç­‰å¾…å®¡æ ¸
APPROVED = "approved"    # é€šè¿‡å®¡æ ¸ï¼Œå‡†å¤‡å‘å¸ƒ
REJECTED = "rejected"    # å®¡æ ¸ä¸é€šè¿‡ï¼Œå«å¤‡æ³¨ä¿¡æ¯
```

**æ³¨æ„**: è¿™æ˜¯ç®€åŒ–çš„3çŠ¶æ€æ¨¡å‹ï¼Œä¸v3è®¡åˆ’çš„å®Œæ•´å·¥ä½œæµç¨‹ä¸åŒ

**æ–‡ä»¶ä½ç½®**:
- æ–‡ç« : `/backend/app/models/article.py`
- è§†é¢‘: `/backend/app/models/video.py`
- ç…§ç‰‡: `/backend/app/models/gallery_db.py`
- è¡Œç¨‹: `/backend/app/models/schedule_db.py`

### 3.2 å®¡æ ¸å·¥ä½œæµç¨‹å®ç°

**å®¡æ ¸APIè·¯ç”±**: `/backend/app/routers/reviews.py`

**ä¸»è¦ç«¯ç‚¹**:
- `POST /api/admin/reviews/{content_type}/{content_id}/approve` - æ‰¹å‡†å†…å®¹
- `POST /api/admin/reviews/{content_type}/{content_id}/reject` - æ‹’ç»å†…å®¹
- `GET /api/admin/reviews/` - è·å–å¾…å®¡æ ¸å†…å®¹åˆ—è¡¨
- `GET /api/admin/reviews/statistics` - å®¡æ ¸ç»Ÿè®¡

**æ”¯æŒçš„å†…å®¹ç±»å‹**:
- articleï¼ˆæ–‡ç« ï¼‰
- videoï¼ˆè§†é¢‘ï¼‰
- scheduleï¼ˆè¡Œç¨‹ï¼‰
- galleryï¼ˆç…§ç‰‡ç»„ï¼‰

### 3.3 å®¡æ ¸ç›¸å…³æ•°æ®åº“å­—æ®µ

æ‰€æœ‰å†…å®¹ç±»å‹éƒ½åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
```python
review_status = Column(String(20), default='pending')  # pending/approved/rejected
reviewer_id = Column(String(36), nullable=True)        # å®¡æ ¸äººID
review_notes = Column(Text, nullable=True)             # å®¡æ ¸æ„è§æˆ–é©³å›åŸå› 
reviewed_at = Column(DateTime, nullable=True)          # å®¡æ ¸æ—¶é—´
```

### 3.4 å½“å‰å·¥ä½œæµç¨‹çš„å±€é™æ€§

- âŒ **æ— è‰ç¨¿çŠ¶æ€**: åˆ›å»ºåç«‹å³è¿›å…¥pendingçŠ¶æ€
- âŒ **æ— å‘å¸ƒçŠ¶æ€**: approvedä»…è¡¨ç¤ºé€šè¿‡ï¼Œä¸ä»£è¡¨å·²å‘å¸ƒ
- âŒ **æ— å¤šçº§å®¡æ ¸**: ä»…æ”¯æŒå•ä¸ªå®¡æ ¸äººå‘˜
- âŒ **æ— ä½œè€…é€šçŸ¥**: å†…å®¹è¢«æ‹’æ—¶æœªé€šçŸ¥ä½œè€…
- âŒ **æ— å®¡æ ¸ä¸­ç¼–è¾‘**: å®¡æ ¸ä¸­çš„å†…å®¹æ— æ³•ç¼–è¾‘
- âš ï¸ **è‡ªåŠ¨å‘å¸ƒ**: æ‰¹å‡†æ“ä½œç«‹å³è®¾ç½®is_published=True

---

## 4. ç®¡ç†å‘˜ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

### 4.1 ç”¨æˆ·æ¨¡å‹

**æ–‡ä»¶**: `/backend/app/models/user_db.py`

```python
class User(Base):
    id = Integer                    # ä¸»é”®
    username = String(50)          # æ˜µç§°ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰
    email = String(100)            # é‚®ç®±
    hashed_password = String(255)  # bcryptå“ˆå¸Œå¯†ç 
    avatar = String(500)           # å¤´åƒè·¯å¾„
    role = String(20)              # guest/user/admin/super_admin
    is_active = Boolean            # æ˜¯å¦æ¿€æ´»
    status = String(20)            # active/inactive/banned
    created_at = DateTime          # åˆ›å»ºæ—¶é—´
    updated_at = DateTime          # æ›´æ–°æ—¶é—´
    last_login = DateTime          # æœ€åç™»å½•æ—¶é—´
```

### 4.2 ç”¨æˆ·åˆ›å»º

**è¶…çº§ç®¡ç†å‘˜åˆå§‹åŒ–**:
- ç«¯ç‚¹: `POST /api/auth/init-super-admin`
- é»˜è®¤å‡­è¯: `root` / `123456`
- éœ€è¦åœ¨å¯åŠ¨æ—¶æ˜¾å¼è°ƒç”¨
- ä»…åˆ›å»ºä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜è´¦æˆ·

**æ™®é€šç”¨æˆ·æ³¨å†Œ**:
- ç«¯ç‚¹: `POST /api/auth/register`
- å…¬å¼€ç«¯ç‚¹ï¼ˆæ— éœ€è®¤è¯ï¼‰
- é‚®ç®±å¿…é¡»å”¯ä¸€
- è‡ªåŠ¨åˆ†é…`user`è§’è‰²

### 4.3 ç®¡ç†å‘˜æ“ä½œ

**æ–‡ä»¶**: `/backend/app/routers/admin.py`

ç®¡ç†å‘˜å¯ä»¥ï¼š
- âœ… æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
- âœ… æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
- âœ… ç¦ç”¨/å¯ç”¨ç”¨æˆ·
- âš ï¸ ä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
- âš ï¸ åˆ é™¤å†…å®¹ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
- âœ… æŸ¥çœ‹ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
- âœ… ç®¡ç†è¡Œç¨‹ï¼ˆåˆ›å»ºã€å®¡æ ¸ã€å‘å¸ƒï¼‰
- âœ… å®¡æ ¸æ–‡ç« ã€è§†é¢‘ã€å›¾ç‰‡

---

## 5. ç®¡ç†å‘˜æ“ä½œæ—¥å¿—ç³»ç»Ÿ

### 5.1 æ—¥å¿—æ¨¡å‹

**æ–‡ä»¶**: `/backend/app/models/admin_log.py`

```python
class AdminLog(Base):
    id = String(36)                    # UUIDä¸»é”®
    action = String(20)                # æ“ä½œç±»å‹
    resource_type = String(20)         # èµ„æºç±»å‹
    resource_id = String(36)           # èµ„æºID
    operator_id = String(36)           # æ“ä½œè€…ID
    operator_username = String(50)     # æ“ä½œè€…ç”¨æˆ·å
    operator_role = String(20)         # æ“ä½œè€…è§’è‰²
    description = String(500)          # æ“ä½œæè¿°
    details = JSON                     # è¯¦ç»†ä¿¡æ¯
    ip_address = String(50)            # IPåœ°å€
    user_agent = String(500)           # æµè§ˆå™¨ä¿¡æ¯
    created_at = DateTime              # åˆ›å»ºæ—¶é—´
```

### 5.2 è®°å½•çš„æ“ä½œç±»å‹

è¢«è¿½è¸ªçš„æ“ä½œåŒ…æ‹¬ï¼š
- APPROVE - å†…å®¹æ‰¹å‡†
- REJECT - å†…å®¹æ‹’ç»
- DELETE - å†…å®¹åˆ é™¤
- BAN - ç”¨æˆ·ç¦ç”¨
- UNBAN - ç”¨æˆ·å¯ç”¨
- ROLE_CHANGE - ç”¨æˆ·è§’è‰²ä¿®æ”¹
- UPDATE - å†…å®¹/è¡Œç¨‹æ›´æ–°
- CREATE - èµ„æºåˆ›å»º

### 5.3 æ—¥å¿—è®¿é—®æ¥å£

**å¯ç”¨ï¿½ï¿½ç‚¹**:
- `GET /api/admin/logs` - æ‰€æœ‰æ—¥å¿—ï¼ˆæ”¯æŒç­›é€‰ï¼‰
- `GET /api/admin/logs/recent` - æœ€è¿‘Næ¡æ—¥å¿—
- `GET /api/admin/logs/count` - æ—¥å¿—æ€»æ•°
- æ”¯æŒç­›é€‰: æ“ä½œç±»å‹ã€èµ„æºç±»å‹ã€æ“ä½œè€…IDã€æ—¥æœŸèŒƒå›´

---

## 6. å‰ç«¯ç®¡ç†åå°ç•Œé¢

### 6.1 åå°å¸ƒå±€ä¸å¯¼èˆª

**æ–‡ä»¶**: `/frontend/src/components/admin/NewAdminLayout.tsx`

**èœå•ç»“æ„**:

**æ™®é€šç”¨æˆ·èœå•**:
- ä»ªè¡¨ç›˜ (Dashboard)
- æˆ‘çš„æ–‡ç«  (My Articles)
- æˆ‘çš„è§†é¢‘ (My Videos)
- æˆ‘çš„å›¾ç‰‡ (My Gallery)
- ä¸ªäººä¸­å¿ƒ (Profile)

**ç®¡ç†å‘˜é¢å¤–èœå•**:
- è¡Œç¨‹ç®¡ç† (Schedule Management)
- æ ‡ç­¾ç®¡ç† (Tag Management)
- æ–‡ç« åˆ—è¡¨ (All Articles)
- è§†é¢‘åˆ—è¡¨ (All Videos)
- å›¾ç‰‡åˆ—è¡¨ (All Gallery)

### 6.2 å—ä¿æŠ¤è·¯ç”±

**æ–‡ä»¶**: `/frontend/src/components/admin/ProtectedRoute.tsx`

```typescript
<ProtectedRoute allowedRoles={['admin', 'super_admin']}>
  <AdminDashboard />
</ProtectedRoute>
```

- æ ¹æ®ç”¨æˆ·è§’è‰²æ£€æŸ¥æƒé™
- æœªç™»å½•ç”¨æˆ·é‡å®šå‘åˆ°ç™»å½•é¡µ
- æƒé™ä¸è¶³çš„ç”¨æˆ·é‡å®šå‘åˆ°é¦–é¡µ

### 6.3 ç®¡ç†å‘˜é¡µé¢

**å·²å®ç°çš„é¡µé¢**:
- Dashboard - æ¦‚è§ˆç»Ÿè®¡
- ArticleList - æŸ¥çœ‹/æ‰¹å‡†/æ‹’ç»æ–‡ç« 
- ScheduleList - ç®¡ç†å·¡æ¼”æ—¥æœŸ
- VideoList - ç®¡ç†è§†é¢‘
- GalleryList - ç®¡ç†ç…§ç‰‡ç»„
- ReviewCenter - é›†ä¸­å®¡æ ¸ä¸­å¿ƒ
- SystemLogs - å®¡è®¡æ—¥å¿—æŸ¥çœ‹å™¨
- UserManagement - ç”¨æˆ·ç®¡ç†é¢æ¿

---

## 7. å½“å‰å®ç° vs. BACKEND_V3_PLANå¯¹æ¯”

### 7.1 å½“å‰çŠ¶æ€æ€»ç»“

| åŠŸèƒ½ | çŠ¶æ€ | è¯¦æƒ… |
|------|------|------|
| **èº«ä»½è®¤è¯** | âœ… éƒ¨åˆ† | JWTä»¤ç‰Œï¼Œæ— åˆ·æ–°æœºåˆ¶ |
| **4çº§RBAC** | âœ… å®Œæ•´ | Guest/User/Admin/SuperAdmin |
| **åŸºäºè§’è‰²çš„å‘å¸ƒ** | âœ… å®Œæ•´ | åˆ†ç±»ç‰¹å®šæƒé™ |
| **å†…å®¹å®¡æ ¸** | âš ï¸ éƒ¨åˆ† | 3çŠ¶æ€ï¼Œæ— è‰ç¨¿ï¼Œæ— å®¡æ ¸ä¸­ç¼–è¾‘ |
| **ç®¡ç†å‘˜æ—¥å¿—** | âœ… å®Œæ•´ | å®Œå–„çš„å®¡è®¡è·Ÿè¸ª |
| **ç”¨æˆ·ç®¡ç†** | âš ï¸ éƒ¨åˆ† | CRUDæ“ä½œä¸å®Œæ•´ |
| **å¯†ç é‡ç½®** | âŒ æ—  | æ— å¯†ç æ¢å¤æœºåˆ¶ |
| **é‚®ç®±éªŒè¯** | âš ï¸ éƒ¨åˆ† | å­˜åœ¨éªŒè¯ç³»ç»Ÿä½†é›†æˆä¸å®Œæ•´ |
| **å¤šå› ç´ è®¤è¯** | âŒ æ—  | æœªå®ç° |
| **é€Ÿç‡é™åˆ¶** | âŒ æ—  | æ— APIé€Ÿç‡é™åˆ¶ |
| **ä¼šè¯ç®¡ç†** | âŒ æ—  | æ— æœåŠ¡å™¨ç«¯ä¼šè¯è·Ÿè¸ª |

### 7.2 å·®å¼‚åˆ†æï¼šv3è®¡åˆ’è¦æ±‚

**v3è®¡åˆ’éœ€è¦çš„**:

1. **å·¥ä½œæµçŠ¶æ€**: draft â†’ pending â†’ approved/rejected â†’ published
   - **å½“å‰**: ä»… pending â†’ approved/rejected
   - **å·®å¼‚**: ç¼ºå°‘è‰ç¨¿å’Œå·²å‘å¸ƒçŠ¶æ€

2. **ä½œè€…æƒé™**: ä»…èƒ½åˆ›å»º/ç¼–è¾‘/åˆ é™¤è‡ªå·±çš„å†…å®¹
   - **å½“å‰**: éƒ¨åˆ†å®ç°ï¼ˆcan_edit_articleæ£€æŸ¥å­˜åœ¨ï¼‰
   - **å·®å¼‚**: æœªåœ¨æ‰€æœ‰å†…å®¹ç±»å‹ä¸­ä¸€è‡´æ‰§è¡Œ

3. **ç®¡ç†å‘˜æƒé™**: å¯å®¡æ ¸ã€å®¡æ ¸ä¸­ç¼–è¾‘ã€åˆ›å»ºå†…å®¹ï¼ˆéœ€å®¡æ ¸ï¼‰
   - **å½“å‰**: å¯å®¡æ ¸å’Œåˆ›å»ºï¼Œä½†æ— æ³•å®¡æ ¸ä¸­ç¼–è¾‘
   - **å·®å¼‚**: æ— å®¡æ ¸ä¸­ç¼–è¾‘å·¥ä½œæµç¨‹

4. **è¶…çº§ç®¡ç†å‘˜**: å®Œå…¨ç³»ç»Ÿæƒé™ï¼ŒåŒ…æ‹¬åˆ é™¤
   - **å½“å‰**: å®Œå…¨å®ç° âœ…
   - **å·®å¼‚**: æ— 

5. **å®¡æ ¸å·¥ä½œæµ**: Submit â†’ Review â†’ Approve/Reject â†’ Publish
   - **å½“å‰**: Create â†’ Pending â†’ Approve/Rejectï¼ˆè‡ªåŠ¨å‘å¸ƒï¼‰
   - **å·®å¼‚**: ç¼ºå°‘æ‰‹åŠ¨å‘å¸ƒæ­¥éª¤ï¼Œæ— æäº¤æ“ä½œ

6. **æ‰€æœ‰æƒæ£€æŸ¥**: ä»…æ‰€æœ‰è€…å’Œç®¡ç†å‘˜å¯åˆ é™¤
   - **å½“å‰**: ä»…æ‰€æœ‰è€…å’Œè¶…çº§ç®¡ç†å‘˜
   - **å·®å¼‚**: ç®¡ç†å‘˜æ— æ³•åˆ é™¤ä»–äººå†…å®¹ï¼ˆåˆç†ä½†ä¸v3ä¸åŒï¼‰

7. **å®¡è®¡è·Ÿè¸ª**: æ‰€æœ‰æ“ä½œå‡è®°å½•ï¼ˆæ“ä½œè€…ã€æ—¶é—´ã€å¤‡æ³¨ï¼‰
   - **å½“å‰**: ä»…ç®¡ç†å‘˜æ“ä½œè¢«è®°å½•
   - **å·®å¼‚**: ç”¨æˆ·æ“ä½œï¼ˆåˆ›å»ºã€ç¼–è¾‘ï¼‰æœªè¢«è®°å½•

### 7.3 æ¶æ„å·®å¼‚

| æ–¹é¢ | å½“å‰ | v3è®¡åˆ’ |
|------|------|--------|
| **CMS** | FastAPI + SQLAlchemy | Strapi + MySQL |
| **å‰ç«¯ç®¡ç†** | è‡ªå®šä¹‰React | Mantine + React Query |
| **å·¥ä½œæµå¼•æ“** | æ‰‹åŠ¨ï¼ˆ3çŠ¶æ€ï¼‰ | Strapi Reviewæ’ä»¶ï¼ˆ5çŠ¶æ€ï¼‰ |
| **ç¼“å­˜å±‚** | æ—  | Redis |
| **æ–‡ä»¶å­˜å‚¨** | æœ¬åœ°/OSS | é˜¿é‡Œäº‘OSS |
| **å¯Œæ–‡æœ¬ç¼–è¾‘** | è‡ªå®šä¹‰ | TipTap |

---

## 8. å®‰å…¨æ€§è¯„ä¼°

### 8.1 ä¼˜åŠ¿

- âœ… Bcryptå¯†ç å“ˆå¸Œï¼ˆå¼ºåº¦é«˜ï¼‰
- âœ… JWTä»¤ç‰Œè®¤è¯ï¼ˆä¸šç•Œæ ‡å‡†ï¼‰
- âœ… åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- âœ… å®Œå–„çš„å®¡è®¡æ—¥å¿—
- âœ… å†…å®¹å®¡æ ¸å·¥ä½œæµç¨‹

### 8.2 åŠ£åŠ¿

- âŒ æ— åˆ·æ–°ä»¤ç‰Œæœºåˆ¶ï¼ˆå®‰å…¨é£é™©ï¼‰
- âŒ ä»¤ç‰Œå­˜å‚¨åœ¨localStorageï¼ˆXSSæ¼æ´ï¼‰
- âŒ æ— å¯†ç é‡ç½®/æ¢å¤
- âŒ æ— è®¤è¯ç«¯ç‚¹é€Ÿç‡é™åˆ¶
- âŒ æ— ä¼šè¯å¤±æ•ˆæœºåˆ¶
- âŒ æ— 2FA/MFA
- âš ï¸ è¶…çº§ç®¡ç†å‘˜å‡­è¯ç¡¬ç¼–ç ï¼ˆé»˜è®¤ï¼šroot/123456ï¼‰
- âš ï¸ æ³¨å†Œæ—¶é‚®ç®±æœªéªŒè¯
- âš ï¸ æ— å¯†ç å¼ºåº¦è¦æ±‚
- âš ï¸ æ— å¤±è´¥ç™»å½•é”å®šæœºåˆ¶

### 8.3 å®‰å…¨åŠ å›ºå»ºè®®

1. **å®ç°åˆ·æ–°ä»¤ç‰Œæœºåˆ¶**ï¼š
   - é¢å‘çŸ­æœŸaccess tokenï¼ˆ15åˆ†é’Ÿï¼‰+ é•¿æœŸrefresh tokenï¼ˆ7å¤©ï¼‰
   - æ¯æ¬¡ä½¿ç”¨æ—¶è½®æ¢refresh token
   - åœ¨httpOnly cookieä¸­å­˜å‚¨refresh token

2. **æ·»åŠ å¯†ç è¦æ±‚**ï¼š
   - æœ€å°‘8ä¸ªå­—ç¬¦
   - åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
   - å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨

3. **é‚®ç®±éªŒè¯**ï¼š
   - æ³¨å†Œåéœ€é‚®ç®±ç¡®è®¤
   - é˜²æ­¢ä½¿ç”¨ä¸€æ¬¡æ€§é‚®ç®±

4. **é€Ÿç‡é™åˆ¶**ï¼š
   - ç™»å½•å°è¯•é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿ5æ¬¡/IPï¼‰
   - å¯†ç é‡ç½®é™åˆ¶ï¼ˆæ¯å°æ—¶1æ¬¡ï¼‰
   - æ³¨å†Œé™åˆ¶ï¼ˆæ¯åˆ†é’Ÿ5æ¬¡/IPï¼‰

5. **ä¼šè¯ç®¡ç†**ï¼š
   - æ·»åŠ æœåŠ¡å™¨ç«¯ä¼šè¯å­˜å‚¨
   - å…è®¸ç”¨æˆ·æ’¤é”€ä»¤ç‰Œ
   - è¿½è¸ªæ¯ä¸ªç”¨æˆ·çš„æ´»è·ƒä¼šè¯

6. **å®¡è®¡å’Œç›‘æ§**ï¼š
   - è®°å½•æ‰€æœ‰è®¤è¯äº‹ä»¶ï¼ˆç™»å½•æˆåŠŸ/å¤±è´¥ã€æ³¨å†Œã€å¯†ç ä¿®æ”¹ï¼‰
   - ç›‘æµ‹å¯ç–‘æ´»åŠ¨ï¼ˆå¤šæ¬¡å¤±è´¥ç™»å½•ã€å¼‚å¸¸IPï¼‰

---

## 9. æ•°æ®åº“æ¨¡å¼æ¦‚è§ˆ

### 9.1 ç”¨æˆ·ä¸è®¤è¯è¡¨

```
users
â”œâ”€â”€ id (ä¸»é”®)
â”œâ”€â”€ username (å”¯ä¸€ï¼Œæ”¯æŒä¸­æ–‡)
â”œâ”€â”€ email (å”¯ä¸€)
â”œâ”€â”€ hashed_password (bcrypt)
â”œâ”€â”€ role (guest/user/admin/super_admin)
â”œâ”€â”€ is_active (å¸ƒå°”å€¼)
â”œâ”€â”€ status (active/inactive/banned)
â”œâ”€â”€ avatar (å¯é€‰)
â”œâ”€â”€ created_at, updated_at, last_login

admin_logs
â”œâ”€â”€ id (UUIDä¸»é”®)
â”œâ”€â”€ action (approve/reject/delete/ban/role_change)
â”œâ”€â”€ resource_type (article/user/scheduleç­‰)
â”œâ”€â”€ resource_id
â”œâ”€â”€ operator_id (å¤–é”®)
â”œâ”€â”€ operator_username
â”œâ”€â”€ operator_role
â”œâ”€â”€ description
â”œâ”€â”€ details (JSON)
â”œâ”€â”€ ip_address, user_agent
â””â”€â”€ created_at
```

### 9.2 åŒ…å«å®¡æ ¸å­—æ®µçš„å†…å®¹è¡¨

æ‰€æœ‰å†…å®¹è¡¨ï¼ˆarticlesã€videosã€photo_groupsã€schedulesï¼‰éƒ½åŒ…å«ï¼š

```
review_status (pending/approved/rejected)
reviewer_id (å¤–é”®è‡³users)
review_notes (æ–‡æœ¬)
reviewed_at (æ—¥æœŸæ—¶é—´)
author_id (å¤–é”®è‡³users)
is_published (å¸ƒå°”å€¼/æ•´æ•°)
```

---

## 10. APIç«¯ç‚¹æ€»ç»“

### 10.1 è®¤è¯ç«¯ç‚¹

| æ–¹æ³• | ç«¯ç‚¹ | éœ€è¦è®¤è¯ | æ‰€éœ€è§’è‰² |
|------|------|---------|---------|
| POST | `/api/auth/register` | å¦ | æ—  |
| POST | `/api/auth/login` | å¦ | æ—  |
| POST | `/api/auth/token` | å¦ | æ—  |
| GET | `/api/auth/me` | æ˜¯ | USER+ |
| POST | `/api/auth/init-super-admin` | å¦ | æ—  |

### 10.2 ç®¡ç†å‘˜ç«¯ç‚¹

| æ–¹æ³• | ç«¯ç‚¹ | éœ€è¦è®¤è¯ | æ‰€éœ€è§’è‰² |
|------|------|---------|---------|
| GET | `/api/admin/articles` | æ˜¯ | ADMIN+ |
| GET | `/api/admin/users` | æ˜¯ | ADMIN+ |
| PUT | `/api/admin/articles/{id}/approve` | æ˜¯ | ADMIN+ |
| PUT | `/api/admin/articles/{id}/reject` | æ˜¯ | ADMIN+ |
| DELETE | `/api/admin/articles/{id}` | æ˜¯ | SUPER_ADMIN |
| PUT | `/api/admin/users/{id}/role` | æ˜¯ | SUPER_ADMIN |
| PUT | `/api/admin/users/{id}/ban` | æ˜¯ | ADMIN+ |
| GET | `/api/admin/logs` | æ˜¯ | ADMIN+ |

### 10.3 å®¡æ ¸ç«¯ç‚¹

| æ–¹æ³• | ç«¯ç‚¹ | éœ€è¦è®¤è¯ | å¤‡æ³¨ |
|------|------|---------|------|
| GET | `/api/admin/reviews/` | æ˜¯ | åˆ—å‡ºå¾…å®¡æ ¸å†…å®¹ |
| GET | `/api/admin/reviews/statistics` | æ˜¯ | å®¡æ ¸ç»Ÿè®¡ |
| POST | `/api/admin/reviews/{type}/{id}/approve` | æ˜¯ | è‡ªåŠ¨å‘å¸ƒ |
| POST | `/api/admin/reviews/{type}/{id}/reject` | æ˜¯ | éœ€è¦å¤‡æ³¨ |

---

## 11. æŒ‰å†…å®¹ç±»å‹çš„å®ç°çŠ¶æ€

### 11.1 æ–‡ç« 

- âœ… åˆ›å»ºç«¯ç‚¹
- âœ… å®¡æ ¸å·¥ä½œæµï¼ˆpending/approved/rejectedï¼‰
- âœ… åŸºäºä½œè€…çš„æƒé™
- âœ… ç®¡ç†å‘˜å®¡æ ¸ç«¯ç‚¹
- âœ… åŸºäºåˆ†ç±»çš„å‘å¸ƒæƒï¿½ï¿½
- âš ï¸ å®¡æ ¸ä¸­ç¼–è¾‘æœªå®ç°
- âš ï¸ è‰ç¨¿çŠ¶æ€ç¼ºå¤±

### 11.2 è§†é¢‘

- âœ… åˆ›å»ºç«¯ç‚¹
- âœ… å®¡æ ¸å­—æ®µåœ¨æ¨¡å‹ä¸­
- âœ… åŸºäºä½œè€…çš„æƒé™
- âš ï¸ å®¡æ ¸å·¥ä½œæµéƒ¨åˆ†å®ç°
- âš ï¸ videosè·¯ç”±ä¸­æ— å®¡æ ¸ç«¯ç‚¹

### 11.3 ç…§ç‰‡/å›¾ç‰‡

- âœ… åˆ›å»ºç«¯ç‚¹
- âœ… å®¡æ ¸å­—æ®µåœ¨æ¨¡å‹ä¸­
- âœ… ä½œè€…è·Ÿè¸ª
- âš ï¸ å®¡æ ¸é›†æˆæœ‰é™
- âŒ æ— ä¸“ç”¨å®¡æ ¸ç«¯ç‚¹

### 11.4 è¡Œç¨‹

- âœ… åˆ›å»ºç«¯ç‚¹
- âœ… å®¡æ ¸å·¥ä½œæµï¼ˆpending/approved/rejectedï¼‰
- âœ… ç®¡ç†å‘˜æ‰¹å‡†ç«¯ç‚¹
- âœ… å‘å¸ƒ/å–æ¶ˆå‘å¸ƒæµç¨‹
- âš ï¸ æ‰¹å‡†æ—¶è‡ªåŠ¨åˆ›å»ºæ–‡ç« 

---

## 12. å…³é”®æ–‡ä»¶ç´¢å¼•

### åç«¯æ ¸å¿ƒ

- `/backend/app/core/security.py` - JWTå’Œå¯†ç å“ˆå¸Œ
- `/backend/app/core/permissions.py` - RBACå‡½æ•°
- `/backend/app/core/dependencies.py` - è®¤è¯ä¾èµ–
- `/backend/app/models/roles.py` - è§’è‰²æšä¸¾
- `/backend/app/models/user_db.py` - ç”¨æˆ·æ¨¡å‹

### åç«¯å†…å®¹

- `/backend/app/models/article.py` - æ–‡ç« æ¨¡å‹
- `/backend/app/models/video.py` - è§†é¢‘æ¨¡å‹
- `/backend/app/models/gallery_db.py` - ç…§ç‰‡æ¨¡å‹
- `/backend/app/models/schedule_db.py` - è¡Œç¨‹æ¨¡å‹
- `/backend/app/models/admin_log.py` - å®¡è®¡æ—¥å¿—æ¨¡å‹

### åç«¯è·¯ç”±

- `/backend/app/routers/auth.py` - ç™»å½•/æ³¨å†Œç«¯ç‚¹
- `/backend/app/routers/admin.py` - ç®¡ç†å‘˜ç®¡ç†ç«¯ç‚¹
- `/backend/app/routers/reviews.py` - å†…å®¹å®¡æ ¸ç«¯ç‚¹
- `/backend/app/routers/articles.py` - æ–‡ç« ç«¯ç‚¹
- `/backend/app/routers/videos.py` - è§†é¢‘ç«¯ç‚¹

### å‰ç«¯è®¤è¯

- `/frontend/src/contexts/AuthContext.tsx` - è®¤è¯çŠ¶æ€ç®¡ç†
- `/frontend/src/components/admin/AdminLogin.tsx` - ç™»å½•ç»„ä»¶
- `/frontend/src/components/admin/ProtectedRoute.tsx` - è·¯ç”±ä¿æŠ¤
- `/frontend/src/components/admin/NewAdminLayout.tsx` - åå°å¸ƒå±€

---

## 13. è¿ç§»åˆ°v3è®¡åˆ’çš„è·¯å¾„

### ç¬¬1é˜¶æ®µï¼šç«‹å³æ”¹è¿›ï¼ˆå½“å‰ç³»ç»Ÿï¼‰
1. æ·»åŠ åˆ·æ–°ä»¤ç‰Œæœºåˆ¶
2. æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯
3. æ·»åŠ é‚®ç®±éªŒè¯
4. æ·»åŠ é€Ÿç‡é™åˆ¶
5. å°†ä»¤ç‰Œä»localStorageè¿ç§»åˆ°httpOnly cookie

### ç¬¬2é˜¶æ®µï¼šå·¥ä½œæµå¢å¼ºï¼ˆå½“å‰ç³»ç»Ÿï¼‰
1. ä¸ºå†…å®¹æ¨¡å‹æ·»åŠ `draft`çŠ¶æ€
2. æ·»åŠ `submit_for_review`æ“ä½œ
3. æ·»åŠ å®¡æ ¸ä¸­ç¼–è¾‘èƒ½åŠ›
4. æ·»åŠ å•ç‹¬çš„`publish`æ“ä½œ
5. åˆ†ç¦»`is_published`å’Œ`review_status`å­—æ®µ

### ç¬¬3é˜¶æ®µï¼šæ¡†æ¶è¿ç§»ï¼ˆv3è®¡åˆ’ï¼‰
1. å»ºç«‹Strapiå®ä¾‹ï¼ˆMySQL + Redisï¼‰
2. åœ¨Strapiä¸­åˆ›å»ºå†…å®¹ç±»å‹
3. é…ç½®å®¡æ ¸å·¥ä½œæµæ’ä»¶
4. åœ¨Strapiä¸­è®¾ç½®åŸºäºè§’è‰²çš„è®¿é—®
5. å°†æ•°æ®ä»FastAPIè¿ç§»åˆ°Strapi
6. æ„å»ºMantineç®¡ç†UI
7. å°†å‰ç«¯åˆ‡æ¢åˆ°ä½¿ç”¨Strapi API
8. åºŸå¼ƒFastAPIç®¡ç†ç«¯ç‚¹

---

## 14. ç»“è®º

å½“å‰ç³»ç»Ÿä¸ºè®¤è¯å’Œæƒé™ç®¡ç†æä¾›äº†**åšå®çš„åŸºç¡€**ï¼Œå…·æœ‰JWTä»¤ç‰Œå’Œ4çº§RBACã€‚ä½†å®ƒç¼ºå°‘BACKEND_V3_PLANæè®®çš„å¤æ‚å·¥ä½œæµå¼•æ“ã€å¤šçŠ¶æ€ç®¡ç†å’Œç°ä»£ç®¡ç†UIã€‚

**å…³é”®è¦ç‚¹**:
- âœ… åŸºç¡€è®¤è¯å’ŒRBACå®ç°è‰¯å¥½
- âš ï¸ å®¡æ ¸å·¥ä½œæµç®€åŒ–ï¼ˆ3çŠ¶æ€vsè®¡åˆ’ä¸­çš„5çŠ¶æ€ï¼‰
- âŒ ç¼ºå°‘è‰ç¨¿çŠ¶æ€å’Œå®¡æ ¸ä¸­ç¼–è¾‘èƒ½åŠ›
- âŒ éœ€è¦å®‰å…¨æ€§æ”¹è¿›ï¼ˆåˆ·æ–°ä»¤ç‰Œã€å¯†ç éªŒè¯ï¼‰
- ğŸ”„ v3è®¡åˆ’éœ€è¦é‡å¤§æ¶æ„å˜æ›´ï¼ˆStrapiè¿ç§»ï¼‰

**å»ºè®®**: åœ¨v3è¿ç§»å‰ï¼Œä¼˜å…ˆå¯¹å½“å‰ç³»ç»Ÿè¿›è¡Œå®‰å…¨åŠ å›ºï¼Œå¹¶æ·»åŠ è‰ç¨¿/å‘å¸ƒçŠ¶æ€åˆ†ç¦»ã€‚

---

**æ–‡æ¡£ç”Ÿæˆ**: 2025-11-01
**ç³»ç»Ÿ**: æ±ªå³°ç²‰ä¸ç½‘è®¤è¯ä¸æƒé™ç³»ç»Ÿåˆ†æ
