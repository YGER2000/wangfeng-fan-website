# 角色权限设计方案

## 1. 角色定义

- **超级管理员 (Super Admin)**：平台最高权限，负责配置、敏感操作与风控。
- **管理员 (Admin)**：负责内容审核与日常运营，可在授权范围内调整内容。
- **注册用户 (User)**：通过实名认证或邮箱注册，可参与互动并提交内容。
- **游客 (Guest)**：未登录访问者，仅能浏览公开内容。

## 2. 权限对象与操作

| 权限对象 | 描述 | 核心操作 |
| -------- | ---- | -------- |
| 页面访问 | 前端公开页面与需要登录的用户中心 | 浏览、跳转 |
| 文章 (Posts) | 包含图文、标签、发布状态 | 创建、编辑、提交审核、撤回、审核、修改、删除、发布 |
| 行程 (Tours) | 演唱会/活动日程 | 创建、编辑、提交审核、审核、修改、删除、发布 |
| 评论 (Comments) | 对文章、行程的评论与回复 | 创建、编辑、删除、审核 (针对违规) |
| 点赞 (Reactions) | 对文章或评论的点赞 | 点赞、取消点赞 |
| 用户信息 (Profiles) | 头像、昵称、简介、角色等 | 查看、修改 |
| 权限配置 | 角色、菜单、操作记录 | 查看、分配、回收 |
| 审计日志 (Audit Log) | 操作记录、审核痕迹 | 查看、导出 |

## 3. 权限矩阵

| 功能/操作 | 超级管理员 | 管理员 | 注册用户 | 游客 |
| --------- | ---------- | ------ | -------- | ---- |
| 浏览全部页面 | ✅ | ✅ | ✅ | ✅ |
| 主题切换、收藏 | ✅ | ✅ | ✅ | ✅ |
| 点赞文章/评论 | ✅ | ✅ | ✅ | ❌ |
| 发表评论 | ✅ | ✅ | ✅ | ❌ |
| 编辑/删除自己的评论 | ✅ | ✅ | ✅ | ❌ |
| 提交文章草稿 | ✅ | ✅ | ✅ | ❌ |
| 编辑草稿 | ✅ | ✅ | ✅ | ❌ |
| 提交文章审核 | ✅ | ✅ | ✅ | ❌ |
| 撤回待审文章 | ✅ | ✅ | ✅ | ❌ |
| 审核文章 | ✅ | ✅ | ❌ | ❌ |
| 修改用户提交的文章（审核时可编辑） | ✅ | ✅ | ❌ | ❌ |
| 发布文章 | ✅ | ✅ | ❌ | ❌ |
| 删除文章 | ✅ | ❌ | ❌ | ❌ |
| 提交行程草稿 | ✅ | ✅ | ✅ | ❌ |
| 审核行程 | ✅ | ✅ | ❌ | ❌ |
| 发布/下线行程 | ✅ | ✅ | ❌ | ❌ |
| 删除行程 | ✅ | ❌ | ❌ | ❌ |
| 查看个人投稿记录 | ✅ | ✅ | ✅ | ❌ |
| 修改自己的头像/昵称 | ✅ | ✅ | ✅ | ❌ |
| 查看全部用户 | ✅ | ✅ (仅基本信息) | ❌ | ❌ |
| 修改他人头像/昵称 | ✅ | ❌ | ❌ | ❌ |
| 调整用户角色 | ✅ | ❌ | ❌ | ❌ |
| 查看审计日志 | ✅ | ✅ | ❌ | ❌ |
| 导出审计日志 | ✅ | ❌ | ❌ | ❌ |

## 4. 操作流程

### 4.1 文章发布流程

1. 注册用户或管理员创建草稿，草稿状态为 `draft`。
2. 用户提交审核后状态变为 `pending_review`，锁定编辑权限，用户仍可撤回。
3. 管理员审核：
   - **通过**：管理员可在审核界面做局部修改，最终置为 `published`。
   - **驳回**：需填写驳回理由，状态变为 `rejected`，作者可再次编辑提交。
4. 超级管理员可对任何状态的文章做强制发布、下线或删除，并写入审计日志。

### 4.2 行程发布流程

与文章流程一致，但审核通过后会触发：
- 更新前端日程列表缓存。

### 4.3 评论管理流程

- 注册用户可发布与删除自己的评论。
- 管理员、超级管理员可删除评论。

### 4.4 点赞限制

- 游客不可点赞。
- 注册用户的点赞记录写入 Redis（去重）与持久化表。
- 点赞/取消操作需落审计日志（含 IP 与 UA）。

### 4.5 审计日志规范

- 记录字段：操作人、角色、操作对象、前后状态、时间戳、终端。
- 所有审核、发布、删除、角色变更必须记录。
- 日志在后台可按对象、操作人、时间范围筛选，支持导出。

## 5. 数据模型建议

### 5.1 用户表 (`users`)

- `id`, `email`, `nickname`, `avatar_url`, `role`, `status`, `created_at`, `updated_at`

### 5.2 角色权限表 (`role_permissions`)

- `role`、`resource`、`action`、`scope`、`created_at`
- 允许未来按资源级别精细授权（如分类、栏目）。

### 5.3 审核记录表 (`review_logs`)

- `id`, `resource_type`, `resource_id`, `action`, `from_status`, `to_status`, `reviewer_id`, `comment`, `created_at`

### 5.4 审计日志表 (`audit_logs`)

- `id`, `actor_id`, `actor_role`, `resource_type`, `resource_id`, `action`, `meta`, `ip`, `user_agent`, `created_at`

## 6. 权限校验策略

- 前端：基于 `role` 与具体资源状态渲染按钮、菜单；对敏感操作提示权限不足。
- 后端：统一中间件进行 RBAC 校验，按「角色 → 资源 → 动作」判断；关键接口需结合资源归属 (`owner_id`) 验证。
- 缓存：将角色与权限映射缓存到 Redis，更新角色后主动失效相关缓存。

## 7. 安全与风控建议

- 所有审核通过的内容触发二次安全检查（敏感词、违法图片识别）。

  

