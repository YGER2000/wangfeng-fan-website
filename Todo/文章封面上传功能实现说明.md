# 文章封面上传功能实现说明

## 功能概述

已成功实现文章封面图片上传功能，用户在发布/编辑文章时可以：
- 从正文图片中选择封面
- 上传自定义封面图片
- 对封面进行 16:9 裁剪
- 封面图片自动上传到服务器
- 封面 URL 保存到数据库

---

## 实现的修改

### 1. 数据库层

#### 新增迁移脚本
- **文件**: `backend/migrations/003_add_article_cover_url.sql`
- **内容**: 为 `articles` 表添加 `cover_url` 字段
- **状态**: ✅ 已执行

```sql
ALTER TABLE articles
ADD COLUMN cover_url VARCHAR(500) DEFAULT NULL COMMENT '文章封面图片URL';

CREATE INDEX idx_articles_cover_url ON articles(cover_url);
```

#### 数据库模型更新
- **文件**: `backend/app/models/article.py`
- **新增字段**: `cover_url = Column(String(500), nullable=True)`

### 2. 后端 API 层

#### Schema 更新
- **文件**: `backend/app/schemas/article.py`
- **修改内容**:
  - `ArticleBase`: 添加 `cover_url` 字段
  - `ArticleUpdate`: 添加 `cover_url` 字段
  - `ArticleInDBBase`: 添加 `cover_url` 字段
  - `ArticleSummary`: 添加 `cover_url` 字段

#### 图片上传 API
- **文件**: `backend/app/routers/upload.py`（已存在）
- **端点**: `POST /api/upload/image`
- **功能**:
  - 支持 JPG, PNG, GIF, WEBP
  - 自动压缩到 1MB 以内
  - 返回图片访问 URL

### 3. 前端实现

#### API 接口
**文件**: `frontend/src/utils/api.ts`

**新增内容**:
```typescript
// 1. ArticleData 和 Article 接口添加 cover_url 字段
export interface ArticleData {
  // ...其他字段
  cover_url?: string;  // 新增：封面图片URL
}

export interface Article extends ArticleData {
  // ...其他字段
  cover_url?: string;  // 封面图片URL
}

// 2. 新增图片上传 API
export const uploadAPI = {
  uploadImage: async (file: File): Promise<{
    url: string;
    filename: string;
    message: string
  }> => {
    const formData = new FormData();
    formData.append('file', file);
    const response = await fetch(`${API_BASE_URL}/upload/image`, {
      method: 'POST',
      body: formData,
    });
    return response.json();
  },
};
```

#### 类型定义更新
**文件**: `frontend/src/utils/contentManager.ts`

```typescript
export interface Article {
  // ...其他字段
  coverImage?: string;    // 旧的封面字段（兼容性）
  coverUrl?: string;      // 新的封面URL字段（从后端获取）
}
```

#### 文章创建页面
**文件**: `frontend/src/components/admin/pages/ArticleCreate.tsx`

**核心逻辑**:
```typescript
const handleSave = async (article: Article, coverImage?: File) => {
  // 1. 如果有封面图片，先上传
  let coverUrl: string | undefined = undefined;
  if (coverImage) {
    const uploadResult = await uploadAPI.uploadImage(coverImage);
    coverUrl = uploadResult.url;
  }

  // 2. 准备文章数据（包含封面URL）
  const articleData = {
    // ...其他字段
    cover_url: coverUrl,
  };

  // 3. 创建文章
  await articleAPI.create(articleData, token);
};
```

#### 文章编辑页面
**文件**: `frontend/src/components/admin/pages/ArticleEdit.tsx`

**核心逻辑**:
```typescript
// 1. 加载时获取现有封面
useEffect(() => {
  const data = await articleAPI.getById(id);
  setInitial({
    // ...其他字段
    coverUrl: data.cover_url, // 加载现有封面
  });
}, [id]);

// 2. 保存时上传新封面（如果有）
const handleSave = async (article: Article, coverImage?: File) => {
  let coverUrl: string | undefined = undefined;
  if (coverImage) {
    const uploadResult = await uploadAPI.uploadImage(coverImage);
    coverUrl = uploadResult.url;
  }

  const updateData = {
    // ...其他字段
    cover_url: coverUrl, // 如果有新封面则更新
  };

  await articleAPI.update(id, updateData, token);
};
```

#### 文章编辑器组件
**文件**: `frontend/src/components/ui/ArticleEditor.tsx`

**新增功能**:
```typescript
// 1. 初始化时加载现有封面
useEffect(() => {
  if (initialArticle?.coverUrl) {
    setCoverImage(initialArticle.coverUrl);
  }
}, [initialArticle?.coverUrl]);

// 2. 封面选择和裁剪功能（已存在）
// - 从正文提取图片
// - 选择正文图片作为封面
// - 上传自定义封面
// - 16:9 裁剪
```

---

## 使用流程

### 创建新文章时
1. **第一步**：填写标题和正文
   - 点击"下一步"按钮

2. **第二步**：设置元数据和封面
   - **选择封面方式**:
     - 从正文图片中选择（默认第一张）
     - 点击"上传封面"上传自定义图片
   - 对封面进行 16:9 裁剪
   - 填写作者、日期、分类、标签等
   - 点击"发布文章"

3. **发布过程**:
   - 封面图片自动上传到服务器
   - 获得图片 URL
   - 文章数据（含封面URL）保存到数据库
   - 根据用户角色显示不同提示

### 编辑已有文章时
1. 自动加载文章现有封面（如果有）
2. 可选择更换封面
3. 保存时：
   - 如果选择了新封面，上传新图片
   - 更新文章的 cover_url 字段

---

## 技术细节

### 封面存储位置
- **上传端点**: `/api/upload/image`
- **存储方式**: 根据配置（本地/OSS/MinIO/R2）
- **本地路径**: `./uploads/` （默认）
- **URL 格式**: 由存储服务返回

### 图片处理
- **支持格式**: JPEG, PNG, GIF, WEBP
- **大小限制**: 原始文件最大 20MB
- **自动压缩**: 压缩到 1MB 以内
- **裁剪比例**: 16:9（在前端完成）

### 安全性
- 文件类型验证
- 文件大小限制
- 管理员权限检查（某些端点）

---

## 测试清单

### 基础功能测试
- [x] 数据库字段添加成功
- [x] 后端 schema 包含 cover_url
- [x] 图片上传 API 可用
- [x] 前端 API 集成完成

### 功能测试（待前端验证）
- [ ] 创建文章时选择正文图片作为封面
- [ ] 创建文章时上传自定义封面
- [ ] 封面裁剪功能正常
- [ ] 封面上传到服务器成功
- [ ] 文章保存时包含封面 URL
- [ ] 编辑文章时加载现有封面
- [ ] 编辑文章时更换封面

### 角色权限测试
- [ ] 管理员发布带封面的文章
- [ ] 普通用户发布带封面的文章（待审核）
- [ ] 封面显示在文章列表
- [ ] 封面显示在文章详情页

---

## 已知问题 / TODO

### ✅ 已解决
- ~~封面图片上传到服务器（需要图片上传API）~~ ✅ 已实现
- ~~数据库缺少 cover_url 字段~~ ✅ 已添加
- ~~前端没有上传API集成~~ ✅ 已集成

### 可能的改进方向
1. **封面管理增强**:
   - 删除旧封面功能（更换封面时）
   - 封面图片列表管理

2. **性能优化**:
   - 封面缩略图生成（不同尺寸）
   - CDN 集成

3. **用户体验**:
   - 封面预览优化
   - 拖拽上传
   - 批量上传

---

## 相关文件清单

### 后端文件
```
backend/
├── migrations/
│   └── 003_add_article_cover_url.sql       # 数据库迁移
├── app/
│   ├── models/
│   │   └── article.py                      # 数据模型（添加 cover_url）
│   ├── schemas/
│   │   └── article.py                      # API Schema（添加 cover_url）
│   └── routers/
│       └── upload.py                       # 图片上传API（已存在）
```

### 前端文件
```
frontend/
└── src/
    ├── utils/
    │   ├── api.ts                          # API 接口（新增 uploadAPI）
    │   └── contentManager.ts               # 类型定义（添加 coverUrl）
    └── components/
        ├── ui/
        │   ├── ArticleEditor.tsx           # 编辑器（加载现有封面）
        │   └── ImageCropModal.tsx          # 裁剪组件（已存在）
        └── admin/pages/
            ├── ArticleCreate.tsx           # 创建页面（集成上传）
            └── ArticleEdit.tsx             # 编辑页面（集成上传）
```

---

## 总结

✅ **封面上传功能已完整实现**，包括：
1. 数据库支持（cover_url 字段）
2. 后端 API 支持（图片上传、数据存储）
3. 前端集成（上传、裁剪、保存）
4. 编辑时加载现有封面

用户现在可以在发布和编辑文章时，选择正文图片或上传自定义图片作为封面，封面会自动上传到服务器并保存 URL 到数据库。
