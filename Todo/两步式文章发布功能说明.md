# 两步式文章发布功能说明

## 📋 功能概述

已成功将文章发布页面改造为两步式流程，提升用户体验，并集成审核发布机制。

---

## ✨ 主要变更

### 1. 两步式发布流程

**第一步：编辑内容**
- 填写文章标题（大字号输入框）
- 编辑文章正文（富文本编辑器）
- 右上角按钮：**下一步** →

**第二步：设置元数据**
- **文章封面**：
  - 自动从正文提取图片作为候选
  - 默认选择第一张图片
  - 可以从正文图片中选择
  - 可以上传自定义封面
  - 16:9 比例裁剪功能
- **文章信息**：
  - 作者
  - 发布日期（三联选择器：年-月-日）
  - 一级分类/二级分类
  - 文章摘要（可选）
  - 标签（可选）
- 右上角按钮：**上一步** | **发布文章**

### 2. 审核发布机制

**普通用户发布**：
- 提交后状态：`review_status = "pending"`, `is_published = false`
- 提示信息：**"发布成功，待管理员审核。"**
- 文章不会立即显示在前台
- 需要管理员审核通过后才能发布

**管理员发布**：
- 提交后状态：`review_status = "approved"`, `is_published = true`
- 提示信息：**"发布成功！"**
- 文章立即发布，可在前台显示

**编辑文章时**：
- 普通用户修改后需要重新审核
- 管理员修改后直接发布

### 3. 封面功能

**从正文选择封面**：
- 自动检测正文中的所有图片
- 以缩略图网格展示
- 点击选择，打开裁剪弹窗

**上传自定义封面**：
- 支持 JPG、PNG 格式
- 建议尺寸：1200x675 像素（16:9）

**封面裁剪**：
- 使用 `react-easy-crop` 库
- 16:9 固定比例
- 支持缩放和旋转
- 支持90度旋转快捷键

---

## 🔧 技术实现

### 前端改动

#### 1. ArticleEditor 组件（`frontend/src/components/ui/ArticleEditor.tsx`）

**新增功能**：
- 步骤管理：`currentStep` (1 | 2)
- 封面管理：从正文提取图片、上传裁剪
- 分步表单渲染
- 审核状态判断

**主要状态**：
```typescript
const [currentStep, setCurrentStep] = useState<1 | 2>(1);
const [coverImage, setCoverImage] = useState<string | null>(null);
const [coverImageFile, setCoverImageFile] = useState<File | null>(null);
const [contentImages, setContentImages] = useState<string[]>([]);
```

#### 2. ImageCropModal 组件（`frontend/src/components/ui/ImageCropModal.tsx`）

**功能**：
- 图片裁剪界面
- 16:9 比例锁定
- 缩放和旋转控制
- 输出裁剪后的 File 对象

#### 3. ArticleCreate & ArticleEdit（`frontend/src/components/admin/pages/`）

**增强**：
- 接收 `coverImage` 参数
- 根据 `currentRole` 判断审核状态
- 传递 `token` 到 API 调用

**创建文章时**：
```typescript
const isAdmin = currentRole === 'admin' || currentRole === 'super_admin';
const articleData = {
  ...basicData,
  review_status: isAdmin ? 'approved' : 'pending',
  is_published: isAdmin,
};
```

#### 4. API 函数（`frontend/src/utils/api.ts`）

**更新签名**：
```typescript
articleAPI.create(articleData, token?)
articleAPI.update(id, articleData, token?)
articleAPI.delete(id, token?)
```

**添加 Authorization header**：
```typescript
if (token) {
  headers['Authorization'] = `Bearer ${token}`;
}
```

### 后端改动

#### 1. Schema 更新（`backend/app/schemas/article.py`）

**ArticleCreate**：
```python
class ArticleCreate(ArticleBase):
    category_primary: str
    category_secondary: str
    review_status: Optional[str] = Field(default="pending", max_length=20)
    is_published: Optional[bool] = Field(default=False)
```

**ArticleUpdate**：
```python
class ArticleUpdate(BaseModel):
    # ... 其他字段
    review_status: Optional[str] = Field(None, max_length=20)
    is_published: Optional[bool] = None
```

**响应模型**：
```python
class Article(ArticleInDBBase):
    # ... 其他字段
    review_status: str  # 包含在响应中
```

#### 2. 数据库模型（`backend/app/models/article.py`）

**已有字段**（无需修改）：
```python
review_status = Column(String(20), default="pending", nullable=False, index=True)
reviewer_id = Column(String(36), nullable=True, index=True)
review_notes = Column(Text, nullable=True)
reviewed_at = Column(DateTime, nullable=True)
is_published = Column(Boolean, default=True)
```

---

## 📦 依赖项

### 新增依赖

```bash
pnpm add react-easy-crop
```

---

## 🎨 界面风格

所有界面遵循现有设计规范：
- ✅ 汪峰紫主题色（#8B5CF6）
- ✅ Light/Dark 双主题适配
- ✅ 统一的圆角、边框、阴影
- ✅ 流畅的过渡动画
- ✅ 响应式布局

---

## 🔍 用户体验细节

### 进度提示
- 标题显示：**"步骤 1/2"** 或 **"步骤 2/2"**
- 按钮状态清晰：下一步 → 上一步 + 发布

### 错误提示
- 第一步未填写标题/内容时，点击"下一步"会提示错误
- API 调用失败时，显示红色错误提示框

### 成功反馈
- 发布成功后显示绿色提示框
- 根据角色显示不同的成功消息
- 2秒后自动跳转到文章列表

### 封面预览
- 实时显示当前选中的封面
- 16:9 比例预览框
- 高亮显示已选中的正文图片

---

## 🚀 后续优化

### 当前 TODO

1. **封面上传到服务器**
   - 目前封面只是前端状态，未上传
   - 需要创建图片上传API
   - 将封面URL保存到文章记录

2. **编辑时加载现有封面**
   - 从数据库读取封面URL
   - 显示在步骤2的预览区域

3. **后台审核界面**
   - 创建审核列表页面（待审核文章）
   - 审核通过/拒绝按钮
   - 审核备注功能

---

## 💡 设计优势

### 相比原方案的改进

**简化代码**：
- ✅ 只需一个 `ArticleEditor` 组件
- ✅ 创建和编辑复用同一组件
- ✅ 无需单独的发布/编辑逻辑

**用户体验**：
- ✅ 分步流程降低认知负荷
- ✅ 封面设置更加直观
- ✅ 正文图片一键选择封面
- ✅ 裁剪功能保证封面比例

**审核机制**：
- ✅ 根据角色自动判断
- ✅ 普通用户体验友好（明确告知需要审核）
- ✅ 管理员无需额外操作
- ✅ 为后续审核流程打下基础

---

## 📖 使用指南

### 发布新文章

1. 访问：`http://localhost:1997/#/admin/articles/create`
2. **步骤1**：填写标题和正文，点击"下一步"
3. **步骤2**：
   - 选择或上传封面
   - 填写作者、日期、分类等信息
   - 添加标签（可选）
   - 点击"发布文章"
4. 等待提示（根据角色不同）
5. 自动跳转到文章列表

### 编辑现有文章

1. 访问：`http://localhost:1997/#/admin/articles/edit/:id`
2. 流程同上
3. 第二步可以删除文章

---

## 🔐 权限说明

### 角色类型

- `guest`：游客（无法发布）
- `user`：普通用户（可发布，需审核）
- `admin`：管理员（可发布，无需审核）
- `super_admin`：超级管理员（可发布，无需审核）

### 权限判断

```typescript
const isAdmin = currentRole === 'admin' || currentRole === 'super_admin';
```

---

## ✅ 测试清单

### 功能测试

- [ ] 步骤切换正常
- [ ] 标题和内容必填验证
- [ ] 从正文提取图片
- [ ] 选择正文图片作为封面
- [ ] 上传自定义封面
- [ ] 封面裁剪功能
- [ ] 日期选择器
- [ ] 分类级联
- [ ] 标签添加/删除

### 角色测试

- [ ] 管理员发布：立即成功
- [ ] 普通用户发布：待审核提示
- [ ] 管理员编辑：立即成功
- [ ] 普通用户编辑：待审核提示

### 界面测试

- [ ] Light 模式样式正常
- [ ] Dark 模式样式正常
- [ ] 响应式布局（桌面/平板/手机）
- [ ] 按钮状态正确
- [ ] 加载动画正常

---

## 📝 注意事项

1. **封面功能暂未完全实现**：
   - 前端已实现裁剪和选择
   - 后端还需要添加图片上传API
   - 数据库需要添加 `cover_url` 字段

2. **审核流程不完整**：
   - 数据库字段已就绪
   - 前端发布时已设置审核状态
   - 还需要开发审核管理界面

3. **编辑时的步骤保持**：
   - 编辑时也是两步流程
   - 加载时默认在步骤1
   - 可以自由切换步骤

---

**最后更新**: 2025-10-17
**开发者**: Claude Code
**版本**: v1.0
