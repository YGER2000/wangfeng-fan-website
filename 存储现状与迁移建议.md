# 存储现状与迁移建议

## 本地存储概况
- `backend/app/core/config.py:29-55` 默认使用 `storage_type = "local"`，指向根目录 `./uploads`，所有调用 `get_storage_service()` 的上传若未覆盖配置都会落在服务器磁盘。
- 目前 `backend/uploads` 下已出现用户上传的多尺寸图片，例如 `backend/uploads/gallery/2025/11/02/5d948573-7091-455c-b040-958c9d3f6f4b*.jpg`。
- 项目静态资源（如 `frontend/public`、`frontend/src/assets`）仍由仓库托管，通过构建结果随站点一并发布，属于允许留在本地的内容。

## 仍在本地保存的用户上传内容
- 图集单图/批量上传：`backend/app/routers/gallery.py:300-393` 使用 `get_storage_service()`，默认写入 `backend/uploads/gallery/...`。
- 文章封面与内文配图：`backend/app/routers/article_upload.py:68-171` 逻辑一致，落地 `backend/uploads/article-covers/...` 等路径。
- 视频封面：`backend/app/routers/videos.py:267-345` 同样写本地目录。
- 用户头像：`backend/app/routers/profile.py:26-139` 直接写入 `frontend/public/images/avatars`；目录下已有 `10000-头像.jpg` 等文件。
- 行程模块曾在 `frontend/public/uploads/schedules` 留下本地海报备份，需要迁移或移除。

## 静态资源保留范围
- 主站 UI 所需的框架脚本、图标、多语言 JSON 以及策划好的示例图片，可继续保存在 `frontend/public` 等目录，由前端构建流程打包分发。
- 若需为静态资源提供 CDN，可使用 OSS 的静态托管或其他对象存储，但无需动态写入；只要保证构建产物中仍可直接引用即可。
- 除上述固定资源外，任何运行期由用户或运营上传、可变的文件（头像、文章配图、活动海报、视频封面等）都必须切换为 OSS 存储，禁止再落盘到仓库或服务器磁盘。

## 已接入或依赖 OSS 的功能
- 行程海报上传使用独立的 `ImageStorage`，见 `backend/app/services/storage.py:15-189`；该服务 `STORAGE_TYPE` 默认 `"oss"`，凭证完整时会直传 OSS。
- 通用上传接口 `/api/upload/image` 也依赖同一套 `ImageStorage`，同样要求完整的 OSS 配置，对象键默认写入 `article-images/general/YYYY/MM/DD/...`。

## 全量迁移至 OSS 的建议
1. 在 `.env` 中统一设置 `STORAGE_TYPE`/`storage_type` 为 `oss`，补齐 `oss_endpoint`、`oss_access_key`、`oss_secret_key`、`oss_bucket`、`oss_custom_domain` 等字段，让所有上传走阿里云，只保留代码仓库自带静态资源。
2. 调整头像上传逻辑，改为复用 `get_storage_service()`，前端使用 OSS/CDN 域名展示头像，避免写入 `frontend/public/images/avatars`。
3. 为文章图集、视频封面等路由补充存储配置覆盖，确保调用 `get_storage_service()` 时走 OSS 通道；必要时提供回退日志便于排查。
4. 编写脚本批量迁移 `backend/uploads`、`frontend/public/uploads` 等现存用户文件到 OSS，更新数据库中对应的 URL，并清理旧文件，确认静态资源目录未被误删。
5. 排查前端仍引用本地上传路径（如 `/uploads/...`）的组件或工具函数，统一改为配置化的 OSS 域名；构建时保留原有静态资源引用，避免误切换。

落实上述步骤后，用户在前后台上传的媒体资源将全部托管在阿里云 OSS，仅保留必要的静态资源与缓存，有助于提升访问性能和运维便利性。
