# 汪峰粉丝网站部署全流程详解

## 概述

本文档详细介绍了从 `git pull` 代码到网站在线可访问的**完整部署过程**。这是一份运维指南，帮助理解：
- 代码更新后如何让服务器加载新代码
- 前端和后端如何协同工作
- 访问服务器 IP 如何就能访问网站

---

## 前置条件

### 初始化部署（一次性）
以下步骤在首次部署时执行，后续更新无需重复：

#### 1. 服务器环境准备
```bash
# Ubuntu 22.04 LTS
# 安装必要工具
sudo apt update
sudo apt install -y \
  python3 python3-pip \
  mysql-server nginx \
  git curl wget
```

#### 2. 数据库配置
```bash
# 启动 MySQL
sudo systemctl start mysql

# 创建数据库和用户
sudo mysql -e "
CREATE DATABASE wangfeng_fan_website CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'appuser'@'localhost' IDENTIFIED WITH mysql_native_password BY '1q3.102w';
GRANT ALL ON wangfeng_fan_website.* TO 'appuser'@'localhost';
FLUSH PRIVILEGES;
"

# 启用 MySQL 开机自启
sudo systemctl enable mysql
```

#### 3. 项目目录结构
```bash
# 创建部署目录
mkdir -p /opt/wangfeng-fan-website
cd /opt/wangfeng-fan-website

# 初始 Git 克隆
git clone https://github.com/你的仓库/wangfeng-fan-website.git .

# 创建必要目录
mkdir -p logs
mkdir -p frontend/public/music  # 用于存储音乐文件
```

#### 4. 配置环境变量
```bash
# 复制 .env 模板并编辑
cp backend/.env.example backend/.env

# 编辑 .env 文件，配置以下内容：
# DATABASE_URL=mysql+pymysql://appuser:1q3.102w@localhost:3306/wangfeng_fan_website
# SECRET_KEY=你的JWT密钥
# OSS_ACCESS_KEY_ID=...（如果使用对象存储）
# OSS_ACCESS_KEY_SECRET=...
# OSS_BUCKET_NAME=...
# OSS_ENDPOINT=...
```

#### 5. 安装 Python 依赖
```bash
# 进入项目目录
cd /opt/wangfeng-fan-website

# 安装 Python 依赖（后端）
pip install -r backend/requirements.txt

# 安装 Node 依赖（前端）
cd frontend
npm install -g pnpm  # 或 corepack enable
pnpm install
cd ..
```

#### 6. 配置 Nginx 反向代理
创建 `/etc/nginx/sites-available/wfnb.cc`：

```nginx
server {
    listen 80;
    server_name wfnb.cc;
    client_max_body_size 50M;

    # 前端静态文件
    location / {
        root /opt/wangfeng-fan-website/frontend/dist;
        try_files $uri /index.html;
        expires 1d;
    }

    # 音乐文件
    location /music/ {
        alias /opt/wangfeng-fan-website/frontend/public/music/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 其他公共资源
    location /data/ {
        alias /opt/wangfeng-fan-website/frontend/public/data/;
        expires 7d;
    }

    location /images/ {
        alias /opt/wangfeng-fan-website/frontend/public/images/;
        expires 7d;
    }

    # 后端 API 代理
    location /api/ {
        proxy_pass http://127.0.0.1:1994;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 60s;
    }

    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss;
    gzip_min_length 1000;
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/wfnb.cc /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl start nginx
sudo systemctl enable nginx  # 开机自启
```

---

## 日常部署流程（代码更新）

当你在本地修改代码并 push 到 GitHub 后，按照以下步骤在服务器上更新网站：

### 步骤 1️⃣ 进入项目目录

```bash
cd /opt/wangfeng-fan-website
```

### 步骤 2️⃣ 拉取最新代码

```bash
git pull origin main
```

**代码会被拉取到以下位置：**
- 前端源代码：`frontend/src/`
- 后端源代码：`backend/app/`
- 配置文件、Dockerfile 等根目录文件

### 步骤 3️⃣ 构建前端（生成静态文件）

前端代码需要编译成静态 HTML/CSS/JS 文件，才能被浏览器访问。

```bash
cd frontend
pnpm install  # 如果有新的依赖，更新依赖包
pnpm build    # 编译前端（约 30-60 秒）
cd ..
```

**这一步会生成：**
- `frontend/dist/` - 前端打包后的所有静态文件
- 包含 `index.html` 和所有 JS/CSS 资源

**为什么需要这步？**
- React 代码需要编译成浏览器能执行的 JavaScript
- 文件会被优化（压缩、去重、打包）
- 构建输出放在 `dist/` 目录，供 Nginx 提供服务

### 步骤 4️⃣ 停止旧的后端进程

```bash
# 强制杀死现有的后端进程（如果有）
pkill -f 'python3.*start.py' || true

# 等待进程完全退出
sleep 2
```

**为什么需要这步？**
- 确保新代码能加载（避免 Python 缓存旧模块）
- 避免端口 1994 被占用

### 步骤 5️⃣ 启动后端服务

```bash
# 在后台启动后端，日志输出到文件
nohup python3 backend/start.py > logs/backend.log 2>&1 &

# 等待后端启动完成（通常 3-5 秒）
sleep 5
```

**这一步做了什么：**
- `python3 backend/start.py` - 启动 FastAPI 应用
- `nohup` - 后台运行（SSH 断开连接后继续运行）
- `> logs/backend.log 2>&1` - 所有输出都写到日志文件
- `&` - 命令后台运行

**后端会监听：**
- 端口 1994（HTTP 服务）
- 自动加载 `backend/.env` 配置文件
- 自动创建/初始化数据库表

### 步骤 6️⃣ 验证服务是否正常运行

#### 检查后端进程
```bash
ps aux | grep 'python3.*start.py' | grep -v grep
```

预期输出：
```
root  12345  0.5  1.2  200000  50000  ?  Ss  10:30  0:05  python3 backend/start.py
```

#### 检查端口监听
```bash
ss -tlnp | grep 1994
```

预期输出：
```
LISTEN  0  128  0.0.0.0:1994  0.0.0.0:*  users:(("python3",pid=12345,fd=5))
```

#### 查看后端日志
```bash
tail -30 logs/backend.log
```

预期日志（最后几行）：
```
INFO:     Application startup complete
INFO:     Uvicorn running on http://0.0.0.0:1994
```

#### 测试后端 API（本地连接）
```bash
curl -s http://127.0.0.1:1994/api/articles/ | head -20
```

预期返回：JSON 格式的文章列表

### 步骤 7️⃣ 验证 Nginx 代理

```bash
# 测试通过 Nginx 访问后端 API
curl -s -H 'Host: wfnb.cc' http://127.0.0.1/api/articles/ | head -10
```

预期：同样返回 JSON 格式的文章列表

#### 查看 Nginx 错误日志
```bash
tail -10 /var/log/nginx/error.log
```

如果没有 502 错误，说明 Nginx 代理配置正确。

---

## 访问网站

部署完成后，用户可以通过以下方式访问网站：

### 通过域名访问
在浏览器中输入：
```
https://wfnb.cc
```

**访问流程：**
1. 用户在浏览器输入域名
2. DNS 解析到服务器 IP（47.111.177.153）
3. 请求到达 Nginx（端口 80）
4. Nginx 根据请求路径处理：
   - 如果是 `/` → 返回前端静态文件（HTML/CSS/JS）
   - 如果是 `/api/` → 转发到后端（端口 1994）
   - 如果是 `/music/` → 返回音乐文件
5. 前端页面加载后，JavaScript 代码会调用后端 API 获取数据

### 通过服务器 IP 访问
如果配置了 DNS 解析：
```
http://47.111.177.153
```

也会访问到同样的网站（前提是 Nginx 配置允许）。

---

## 完整部署脚本（推荐）

为了简化操作，可以创建一个部署脚本 `deploy.sh`：

```bash
#!/bin/bash

# 进入项目目录
cd /opt/wangfeng-fan-website

# 1. 拉取最新代码
echo "📥 拉取最新代码..."
git pull origin main

# 2. 构建前端
echo "🔨 构建前端..."
cd frontend
pnpm install
pnpm build
cd ..

# 3. 停止旧后端
echo "🛑 停止旧后端进程..."
pkill -f 'python3.*start.py' || true
sleep 2

# 4. 启动新后端
echo "🚀 启动后端服务..."
nohup python3 backend/start.py > logs/backend.log 2>&1 &
sleep 5

# 5. 验证服务
echo "✅ 验证服务状态..."
if ps aux | grep -q 'python3.*start.py' | grep -v grep; then
    echo "✓ 后端进程运行中"
else
    echo "✗ 后端进程启动失败！"
    tail -20 logs/backend.log
    exit 1
fi

if curl -s http://127.0.0.1:1994/api/articles/ > /dev/null; then
    echo "✓ 后端 API 正常"
else
    echo "✗ 后端 API 无法连接！"
    exit 1
fi

echo ""
echo "🎉 部署完成！"
echo "访问地址：https://wfnb.cc"
```

使用：
```bash
chmod +x deploy.sh
./deploy.sh
```

---

## 关键文件和目录

| 路径 | 说明 | 用途 |
|------|------|------|
| `/opt/wangfeng-fan-website/` | 项目根目录 | 代码存放位置 |
| `frontend/src/` | 前端源代码 | React 组件、页面 |
| `frontend/dist/` | 前端打包输出 | Nginx 提供给浏览器 |
| `backend/app/` | 后端源代码 | FastAPI 应用逻辑 |
| `backend/.env` | 环境变量配置 | 数据库、API 密钥 |
| `logs/backend.log` | 后端运行日志 | 调试和监控 |
| `/etc/nginx/sites-available/wfnb.cc` | Nginx 配置 | 反向代理规则 |

---

## 故障排查

### 问题 1：后端无法启动

**症状：** 后端进程没有启动，或立即退出

**排查步骤：**
```bash
# 1. 查看日志
tail -50 logs/backend.log

# 2. 直接运行后端（查看完整错误）
cd /opt/wangfeng-fan-website
python3 backend/start.py

# 3. 检查 .env 配置
grep DATABASE_URL backend/.env
```

**常见原因：**
- `DATABASE_URL` 配置错误 → 检查数据库用户名密码
- Python 依赖缺失 → 运行 `pip install -r backend/requirements.txt`
- 端口 1994 被占用 → 运行 `lsof -i :1994` 查看

### 问题 2：访问网站显示 502 错误

**症状：** 浏览器访问 https://wfnb.cc 显示 502 Bad Gateway

**排查步骤：**
```bash
# 1. 检查后端进程
ps aux | grep 'python3.*start.py' | grep -v grep

# 2. 检查后端是否监听 1994
ss -tlnp | grep 1994

# 3. 测试后端直连
curl http://127.0.0.1:1994/api/articles/

# 4. 查看 Nginx 错误日志
tail -20 /var/log/nginx/error.log
```

**常见原因：**
- 后端进程未运行 → 重新启动后端
- Nginx 配置中 `proxy_pass` 地址错误 → 检查 `/etc/nginx/sites-available/wfnb.cc`
- 防火墙阻止 → 检查 `sudo ufw status`

### 问题 3：前端加载了但页面没有数据

**症状：** 页面可以打开，但文章、图片等内容为空

**排查步骤：**
```bash
# 1. 打开浏览器开发者工具（F12）
# 2. 查看 Network 标签，检查 API 请求是否成功
# 3. 查看 Console 标签，看是否有 JavaScript 错误
# 4. 测试 API 端点
curl http://127.0.0.1:1994/api/articles/
```

**常见原因：**
- 后端数据库没有数据 → 插入测试数据
- API 路由配置错误 → 检查 `backend/app/routers/`
- 前端代码中的 API 地址错误 → 检查 `frontend/src/utils/api.ts`

### 问题 4：部署后前端还是显示旧内容

**症状：** 更新了前端代码，但浏览器显示的还是旧页面

**原因和解决：**
```bash
# 1. 确保前端已重新构建
cd frontend
pnpm build
cd ..

# 2. 强制浏览器清除缓存
# - 在浏览器中按 Ctrl+Shift+Delete（Windows/Linux）或 Cmd+Shift+Delete（Mac）
# - 清除所有缓存

# 3. 检查 Nginx 是否正确加载了新的 dist 文件
ls -la frontend/dist/ | head

# 4. 重启 Nginx
sudo systemctl restart nginx
```

---

## 性能优化建议

### 1. 启用 HTTP 压缩
Nginx 配置中已启用 Gzip，减少传输数据量。

### 2. 启用 HTTPS
生成 SSL 证书并配置：
```bash
sudo certbot --nginx -d wfnb.cc
```

### 3. 使用 CDN
将音乐、图片等大文件通过 CDN 分发，减轻服务器压力。

### 4. 添加进程监控
使用 systemd 或 supervisor 自动重启挂掉的进程：

创建 `/etc/systemd/system/wangfeng-backend.service`：
```ini
[Unit]
Description=Wangfeng Fan Website Backend
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/opt/wangfeng-fan-website
ExecStart=/usr/bin/python3 backend/start.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用：
```bash
sudo systemctl daemon-reload
sudo systemctl enable wangfeng-backend
sudo systemctl start wangfeng-backend
```

---

## 总结

完整的部署流程分为两个阶段：

### 初始化部署（一次性）
1. 准备服务器环境（Python、MySQL、Nginx）
2. 配置数据库和用户
3. 克隆代码到 `/opt/wangfeng-fan-website`
4. 配置 `.env` 和 Nginx

### 日常部署（每次代码更新）
1. `git pull origin main` - 拉取最新代码
2. `cd frontend && pnpm build` - 构建前端静态文件
3. `pkill -f 'python3.*start.py'` - 停止旧后端
4. `nohup python3 backend/start.py > logs/backend.log 2>&1 &` - 启动新后端
5. 验证服务正常运行

用户访问 IP 地址或域名时，Nginx 将：
- 静态资源请求 → 直接返回前端构建的文件
- API 请求 → 转发给后端服务处理

这样就实现了"访问 IP 就能看到网站"的效果！
